<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survalyzer Questionnaire Comparison</title>
<style>
  :root {
    --green: #c6efce;
    --green-border: #6aa84f;
    --yellow: #fff2cc;
    --yellow-border: #f1c232;
    --red: #f4cccc;
    --red-border: #cc4125;
    --grey: #d9d9d9;
    --grey-border: #999;
    --lightgrey: #efefef;
    --lightgrey-border: #ccc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px; color: #333; padding: 20px; background: #fafafa; }
  h1 { margin-bottom: 8px; }
  .subtitle { margin-bottom: 16px; color: #666; font-size: 13px; }
  .loading { text-align: center; padding: 40px; color: #666; }
  .error { text-align: center; padding: 40px; color: #cc0000; }

  .summary { margin-bottom: 20px; padding: 12px 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; display: flex; gap: 24px; flex-wrap: wrap; }
  .summary .stat { text-align: center; }
  .summary .stat .num { font-size: 24px; font-weight: 700; }
  .summary .stat .label { font-size: 12px; color: #666; text-transform: uppercase; }

  .legend { margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
  .legend span { padding: 3px 10px; border-radius: 4px; font-size: 12px; }
  .legend .green { background: var(--green); border: 1px solid var(--green-border); }
  .legend .yellow { background: var(--yellow); border: 1px solid var(--yellow-border); }
  .legend .red { background: var(--red); border: 1px solid var(--red-border); }
  .legend .grey { background: var(--grey); border: 1px solid var(--grey-border); }

  .filter-bar { margin-bottom: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .filter-bar label { font-weight: 600; }
  .filter-bar select, .filter-bar input { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }

  .section-group { margin-bottom: 24px; }
  .section-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; padding: 6px 12px; background: #e8e8e8; border-radius: 4px; cursor: pointer; }
  .section-title:hover { background: #ddd; }

  table { width: 100%; border-collapse: collapse; background: #fff; }
  th, td { padding: 8px 10px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
  th { background: #f5f5f5; font-weight: 600; position: sticky; top: 0; z-index: 2; }
  th.survey-col { font-size: 11px; min-width: 80px; max-width: 120px; }
  .code-col { width: 140px; font-family: monospace; font-weight: 600; }
  .type-col { width: 110px; font-size: 12px; color: #666; }
  .text-col { min-width: 200px; }

  .cell-green { background: var(--green); }
  .cell-yellow { background: var(--yellow); }
  .cell-red { background: var(--red); }
  .cell-grey { background: var(--grey); }
  .cell-lightgrey { background: var(--lightgrey); }

  .status-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge-identical { background: var(--green); color: #274e13; }
  .badge-exact { background: var(--green); color: #274e13; }
  .badge-text_changed { background: var(--yellow); color: #7f6000; }
  .badge-similar { background: var(--yellow); color: #7f6000; }
  .badge-different { background: var(--red); color: #660000; }
  .badge-structure_changed { background: var(--red); color: #660000; }
  .badge-added { background: var(--grey); color: #333; }
  .badge-removed { background: transparent; color: #999; font-weight: normal; }

  .detail-row { display: none; }
  .detail-row.open { display: table-row; }
  .detail-content { padding: 12px 16px; background: #fefefe; }
  .detail-content h4 { margin: 16px 0 8px; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
  .detail-content h4:first-child { margin-top: 0; }
  .detail-content table { margin: 4px 0 12px; font-size: 12px; table-layout: fixed; width: 100%; }
  .detail-content td, .detail-content th { padding: 4px 8px; }
  .detail-content .text-cell { overflow: hidden; text-overflow: ellipsis; }
  /* Consistent column widths for detail tables */
  .detail-content .col-code { width: 120px; font-family: monospace; }
  .detail-content .col-status { width: 100px; }
  .detail-content .col-sim { width: 70px; text-align: right; }
  .detail-content .col-text { min-width: 150px; }

  .clickable { cursor: pointer; }
  .clickable:hover { filter: brightness(0.95); }
</style>
</head>
<body>

<h1>Questionnaire Comparison Report</h1>
<p class="subtitle">Each survey compared against master</p>

<div id="app">
  <div class="loading">Loading data...</div>
</div>

<script>
const STATUS_COLOR = {
  identical: 'green',
  text_changed: 'yellow',
  structure_changed: 'red',
  added: 'grey',
  removed: 'lightgrey'
};

let DATA = null;
let currentLanguage = 'de-ch';
let currentFilter = 'all';
let searchTerm = '';

async function loadData() {
  try {
    const response = await fetch('data.json');
    if (!response.ok) throw new Error('Failed to load data.json');
    DATA = await response.json();
    currentLanguage = DATA.meta.languages.includes('de-ch') ? 'de-ch' : DATA.meta.languages[0];
    render();
  } catch (err) {
    document.getElementById('app').innerHTML = `<div class="error">Error loading data: ${err.message}</div>`;
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function truncate(text, len) {
  if (!text) return '';
  return text.length > len ? text.slice(0, len) + '...' : text;
}

function getWorstStatus(code) {
  const codeDiffs = DATA.diffs[code] || {};
  let worst = 'identical';
  const priority = ['structure_changed', 'text_changed', 'added', 'removed', 'identical'];
  for (const survey of DATA.meta.survey_names) {
    const diff = codeDiffs[survey];
    if (diff && priority.indexOf(diff.status) < priority.indexOf(worst)) {
      worst = diff.status;
    }
  }
  return worst;
}

function shouldShowRow(code) {
  const status = getWorstStatus(code);
  if (currentFilter === 'all') return true;
  if (currentFilter === 'changed') return status !== 'identical';
  return status === currentFilter;
}

function matchesSearch(code) {
  if (!searchTerm) return true;
  const term = searchTerm.toLowerCase();
  if (code.toLowerCase().includes(term)) return true;
  const master = DATA.master[code];
  if (master) {
    for (const text of Object.values(master.texts)) {
      if (text.toLowerCase().includes(term)) return true;
    }
  }
  return false;
}

function renderSummary() {
  const s = DATA.meta.status_counts;
  return `
    <div class="summary">
      <div class="stat"><div class="num">${DATA.meta.total_questions}</div><div class="label">Total Questions</div></div>
      <div class="stat"><div class="num">${s.identical || 0}</div><div class="label">Identical</div></div>
      <div class="stat"><div class="num">${s.text_changed || 0}</div><div class="label">Text Changed</div></div>
      <div class="stat"><div class="num">${s.structure_changed || 0}</div><div class="label">Structure Changed</div></div>
      <div class="stat"><div class="num">${(s.added || 0) + (s.removed || 0)}</div><div class="label">Added / Removed</div></div>
    </div>
    <div class="legend">
      <span class="green">Identical to master</span>
      <span class="yellow">Text changed</span>
      <span class="red">Structure changed</span>
      <span class="grey">Not in master / Not in survey</span>
    </div>
  `;
}

function renderFilters() {
  const langOptions = DATA.meta.languages.map(l =>
    `<option value="${l}"${l === currentLanguage ? ' selected' : ''}>${l}</option>`
  ).join('');
  return `
    <div class="filter-bar">
      <label for="language-filter">Language:</label>
      <select id="language-filter">${langOptions}</select>
      <label for="status-filter">Filter:</label>
      <select id="status-filter">
        <option value="all"${currentFilter === 'all' ? ' selected' : ''}>All</option>
        <option value="identical"${currentFilter === 'identical' ? ' selected' : ''}>Identical</option>
        <option value="text_changed"${currentFilter === 'text_changed' ? ' selected' : ''}>Text Changed</option>
        <option value="structure_changed"${currentFilter === 'structure_changed' ? ' selected' : ''}>Structure Changed</option>
        <option value="added"${currentFilter === 'added' ? ' selected' : ''}>Added</option>
        <option value="removed"${currentFilter === 'removed' ? ' selected' : ''}>Removed</option>
        <option value="changed"${currentFilter === 'changed' ? ' selected' : ''}>Any Change</option>
      </select>
      <label for="search-box">Search:</label>
      <input type="text" id="search-box" placeholder="Question code or text..." value="${escapeHtml(searchTerm)}">
    </div>
  `;
}

function renderQuestionRow(code) {
  const master = DATA.master[code];
  const codeDiffs = DATA.diffs[code] || {};
  const worstStatus = getWorstStatus(code);

  const masterText = master ? escapeHtml(truncate(master.texts[currentLanguage] || '', 120)) : '—';
  const elementType = master ? master.element_type : '—';

  let surveyCells = '';
  for (const survey of DATA.meta.survey_names) {
    const diff = codeDiffs[survey];
    if (diff) {
      const color = STATUS_COLOR[diff.status] || '';
      const label = diff.status === 'removed' ? '—' : diff.status.replace('_', ' ');
      surveyCells += `<td class="cell-${color} clickable" onclick="toggleDetail('${code}')">
        <span class="status-badge badge-${diff.status}">${label}</span>
      </td>`;
    } else {
      surveyCells += `<td class="cell-lightgrey">—</td>`;
    }
  }

  return `
    <tr class="question-row" data-code="${code}" data-status="${worstStatus}">
      <td class="code-col">${escapeHtml(code)}</td>
      <td class="type-col">${escapeHtml(elementType)}</td>
      <td class="text-col">${masterText || '—'}</td>
      ${surveyCells}
    </tr>
    <tr class="detail-row" id="detail-${code}">
      <td colspan="${3 + DATA.meta.survey_names.length}">
        <div class="detail-content">${renderDetailContent(code)}</div>
      </td>
    </tr>
  `;
}

function renderDetailContent(code) {
  const master = DATA.master[code];
  const codeDiffs = DATA.diffs[code] || {};
  const shortNames = DATA.meta.short_names;
  let html = '';

  // Question Text Section (filtered to selected language)
  html += '<h4>Question</h4><table><colgroup><col class="col-status"><col class="col-sim"><col class="col-text">';
  for (const survey of DATA.meta.survey_names) html += '<col class="col-text">';
  html += '</colgroup><tr><th>Status</th><th>Similarity</th><th>Master Text</th>';
  for (const survey of DATA.meta.survey_names) {
    html += `<th>${escapeHtml(shortNames[survey] || survey)} Text</th>`;
  }
  html += '</tr>';

  const masterText = master ? (master.texts[currentLanguage] || '') : '';
  let worstStatus = 'exact';
  let worstSim = 1.0;
  let surveyTexts = [];

  for (const survey of DATA.meta.survey_names) {
    const diff = codeDiffs[survey];
    let surveyText = '';
    if (diff && diff.text_diffs) {
      for (const td of diff.text_diffs) {
        if (td.language === currentLanguage) {
          surveyText = td.new_text || '';
          if (td.status === 'different') worstStatus = 'different';
          else if (['similar', 'added', 'removed'].includes(td.status) && worstStatus === 'exact') worstStatus = td.status;
          if (td.similarity < worstSim) worstSim = td.similarity;
        }
      }
    }
    surveyTexts.push(surveyText);
  }

  html += `<tr><td><span class="status-badge badge-${worstStatus}">${worstStatus}</span></td>`;
  html += `<td>${Math.round(worstSim * 100)}%</td>`;
  html += `<td class="text-cell">${escapeHtml(truncate(masterText, 150)) || '—'}</td>`;
  for (const st of surveyTexts) {
    html += `<td class="text-cell">${escapeHtml(truncate(st, 150)) || '—'}</td>`;
  }
  html += '</tr></table>';

  // Answer Options Section
  const allChoiceCodes = new Set();
  if (master && master.choices) {
    for (const c of master.choices) allChoiceCodes.add(c.code);
  }
  for (const survey of DATA.meta.survey_names) {
    const surveyQ = DATA.surveys[survey] ? DATA.surveys[survey][code] : null;
    if (surveyQ && surveyQ.choices) {
      for (const c of surveyQ.choices) allChoiceCodes.add(c.code);
    }
  }

  if (allChoiceCodes.size > 0) {
    html += '<h4>Answer Options</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const survey of DATA.meta.survey_names) html += '<col class="col-text">';
    html += '</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>Master Text</th>';
    for (const survey of DATA.meta.survey_names) {
      html += `<th>${escapeHtml(shortNames[survey] || survey)} Text</th>`;
    }
    html += '</tr>';

    for (const choiceCode of allChoiceCodes) {
      let masterChoiceText = '';
      if (master && master.choices) {
        const mc = master.choices.find(c => c.code === choiceCode);
        if (mc) masterChoiceText = mc.texts[currentLanguage] || '';
      }

      let worstStatus = 'identical';
      let worstSim = 1.0;
      const diff = codeDiffs[DATA.meta.survey_names[0]];
      if (diff && diff.choice_diffs) {
        for (const cd of diff.choice_diffs) {
          if (cd.code === choiceCode) {
            if (cd.status === 'structure_changed') worstStatus = 'structure_changed';
            else if (cd.status === 'text_changed' && worstStatus !== 'structure_changed') worstStatus = 'text_changed';
            else if (['added', 'removed'].includes(cd.status) && worstStatus === 'identical') worstStatus = cd.status;
            for (const td of cd.text_diffs) {
              if (td.similarity < worstSim) worstSim = td.similarity;
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(choiceCode)}</td>`;
      html += `<td><span class="status-badge badge-${worstStatus}">${worstStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(worstSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(masterChoiceText, 100)) || '—'}</td>`;

      for (const survey of DATA.meta.survey_names) {
        let surveyChoiceText = '';
        const surveyQ = DATA.surveys[survey] ? DATA.surveys[survey][code] : null;
        if (surveyQ && surveyQ.choices) {
          const sc = surveyQ.choices.find(c => c.code === choiceCode);
          if (sc) surveyChoiceText = sc.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(surveyChoiceText, 100)) || '—'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  // Matrix Rows Section
  const allRowCodes = new Set();
  if (master && master.matrix_rows) {
    for (const r of master.matrix_rows) allRowCodes.add(r.code);
  }
  for (const survey of DATA.meta.survey_names) {
    const surveyQ = DATA.surveys[survey] ? DATA.surveys[survey][code] : null;
    if (surveyQ && surveyQ.matrix_rows) {
      for (const r of surveyQ.matrix_rows) allRowCodes.add(r.code);
    }
  }

  if (allRowCodes.size > 0) {
    html += '<h4>Matrix Rows</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const survey of DATA.meta.survey_names) html += '<col class="col-text">';
    html += '</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>Master Text</th>';
    for (const survey of DATA.meta.survey_names) {
      html += `<th>${escapeHtml(shortNames[survey] || survey)} Text</th>`;
    }
    html += '</tr>';

    for (const rowCode of allRowCodes) {
      let masterRowText = '';
      if (master && master.matrix_rows) {
        const mr = master.matrix_rows.find(r => r.code === rowCode);
        if (mr) masterRowText = mr.texts[currentLanguage] || '';
      }

      html += `<tr><td class="col-code">${escapeHtml(rowCode)}</td>`;
      html += `<td><span class="status-badge badge-identical">identical</span></td>`;
      html += `<td>100%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(masterRowText, 100)) || '—'}</td>`;

      for (const survey of DATA.meta.survey_names) {
        let surveyRowText = '';
        const surveyQ = DATA.surveys[survey] ? DATA.surveys[survey][code] : null;
        if (surveyQ && surveyQ.matrix_rows) {
          const sr = surveyQ.matrix_rows.find(r => r.code === rowCode);
          if (sr) surveyRowText = sr.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(surveyRowText, 100)) || '—'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  // Matrix Columns Section
  const allColCodes = new Set();
  if (master && master.matrix_columns) {
    for (const c of master.matrix_columns) allColCodes.add(c.code);
  }
  for (const survey of DATA.meta.survey_names) {
    const surveyQ = DATA.surveys[survey] ? DATA.surveys[survey][code] : null;
    if (surveyQ && surveyQ.matrix_columns) {
      for (const c of surveyQ.matrix_columns) allColCodes.add(c.code);
    }
  }

  if (allColCodes.size > 0) {
    html += '<h4>Matrix Columns</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const survey of DATA.meta.survey_names) html += '<col class="col-text">';
    html += '</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>Master Text</th>';
    for (const survey of DATA.meta.survey_names) {
      html += `<th>${escapeHtml(shortNames[survey] || survey)} Text</th>`;
    }
    html += '</tr>';

    for (const colCode of allColCodes) {
      let masterColText = '';
      if (master && master.matrix_columns) {
        const mc = master.matrix_columns.find(c => c.code === colCode);
        if (mc) masterColText = mc.texts[currentLanguage] || '';
      }

      html += `<tr><td class="col-code">${escapeHtml(colCode)}</td>`;
      html += `<td><span class="status-badge badge-identical">identical</span></td>`;
      html += `<td>100%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(masterColText, 100)) || '—'}</td>`;

      for (const survey of DATA.meta.survey_names) {
        let surveyColText = '';
        const surveyQ = DATA.surveys[survey] ? DATA.surveys[survey][code] : null;
        if (surveyQ && surveyQ.matrix_columns) {
          const sc = surveyQ.matrix_columns.find(c => c.code === colCode);
          if (sc) surveyColText = sc.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(surveyColText, 100)) || '—'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  return html;
}

function renderSection(sectionName, codes) {
  const filteredCodes = codes.filter(code => shouldShowRow(code) && matchesSearch(code));
  if (filteredCodes.length === 0) return '';

  const surveyHeaders = DATA.meta.survey_names.map(s =>
    `<th class="survey-col">${escapeHtml(DATA.meta.short_names[s] || s)}</th>`
  ).join('');

  const rows = filteredCodes.map(code => renderQuestionRow(code)).join('');

  return `
    <div class="section-group" data-section="${escapeHtml(sectionName)}">
      <div class="section-title" onclick="toggleSection(this)">${escapeHtml(sectionName)} (${filteredCodes.length} questions)</div>
      <table>
        <thead>
          <tr>
            <th class="code-col">Code</th>
            <th class="type-col">Type</th>
            <th class="text-col">Master Text</th>
            ${surveyHeaders}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function render() {
  let html = renderSummary() + renderFilters();

  for (const [sectionName, codes] of Object.entries(DATA.meta.sections)) {
    html += renderSection(sectionName, codes);
  }

  document.getElementById('app').innerHTML = html;
  attachEventListeners();
}

function attachEventListeners() {
  document.getElementById('language-filter').addEventListener('change', function() {
    currentLanguage = this.value;
    render();
  });

  document.getElementById('status-filter').addEventListener('change', function() {
    currentFilter = this.value;
    render();
  });

  document.getElementById('search-box').addEventListener('input', function() {
    searchTerm = this.value;
    render();
  });
}

function toggleDetail(code) {
  const row = document.getElementById('detail-' + code);
  if (row) row.classList.toggle('open');
}

function toggleSection(el) {
  const table = el.nextElementSibling;
  if (table) table.style.display = table.style.display === 'none' ? '' : 'none';
}

// Load data on page load
loadData();
</script>

</body>
</html>
