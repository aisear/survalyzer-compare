<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survalyzer Questionnaire Comparison</title>
<style>
  :root {
    --accent: #3B6CB4;
    --accent-bg: rgba(59, 108, 180, 0.10);
    --neutral: #E8E5E1;
    --text: #1A1A1A;
    --text-secondary: #777;
    --rule: #E0E0E0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 14px;
    color: var(--text);
    padding: 32px;
    background: #fff;
    line-height: 1.5;
  }

  h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
  .subtitle { font-size: 14px; color: #888; margin-bottom: 48px; }
  .loading { text-align: center; padding: 48px; color: var(--text-secondary); }
  .error { text-align: center; padding: 48px; color: #cc0000; }

  /* Summary bar */
  .summary { margin-bottom: 24px; }
  .summary-bar {
    display: flex;
    height: 8px;
    width: 100%;
    border: 1px solid var(--rule);
    overflow: hidden;
    margin-bottom: 8px;
  }
  .bar-identical { background: #fff; }
  .bar-changed { background: var(--accent); }
  .bar-missing { background: var(--neutral); }
  .summary-text { font-size: 14px; color: var(--text-secondary); }

  /* Toolbar */
  .toolbar { margin-bottom: 24px; }
  .toolbar-primary {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    padding-bottom: 16px;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--rule);
  }
  .toolbar-secondary {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  .toolbar label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
  }
  .toolbar select,
  .toolbar input[type="text"] {
    padding: 8px;
    border: 1px solid var(--rule);
    border-radius: 2px;
    font-size: 14px;
    color: var(--text);
    background: #fff;
  }
  .target-option {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .target-option input[type="checkbox"] { cursor: pointer; }
  .target-option > label {
    cursor: pointer;
    font-size: 14px;
    text-transform: none;
    letter-spacing: normal;
    font-weight: 400;
    color: var(--text);
  }
  .checkbox-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text);
    text-transform: none;
    letter-spacing: normal;
    font-weight: 400;
  }

  /* Sections */
  .section-group { margin-bottom: 32px; }
  .section-title {
    border-top: 2px solid var(--text);
    padding: 8px 0 16px;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    cursor: pointer;
    background: none;
  }
  .section-title:hover { opacity: 0.7; }
  .section-count {
    font-size: 14px;
    font-weight: 400;
    color: var(--text-secondary);
    text-transform: none;
    letter-spacing: normal;
  }
  .section-alias {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 400;
    text-transform: none;
    letter-spacing: normal;
    margin-left: 8px;
  }

  /* Tables */
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th, td { padding: 8px 16px; text-align: left; vertical-align: top; }
  th {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--rule);
    position: sticky;
    top: 0;
    z-index: 2;
    background: #fff;
  }
  th.survey-col { min-width: 90px; max-width: 130px; text-align: center; }
  .code-col { width: 180px; font-weight: 600; }
  .type-col { width: 110px; color: var(--text-secondary); }
  .text-col { min-width: 200px; }

  /* Row change indicators */
  tr.row-changed > td:first-child { box-shadow: inset 3px 0 0 var(--accent); }
  tr.row-missing > td:first-child { box-shadow: inset 3px 0 0 var(--neutral); }

  /* Status badges - text only */
  .status-badge {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .badge-identical, .badge-exact { color: var(--text); }
  .badge-text_changed, .badge-similar, .badge-different, .badge-structure_changed { color: var(--accent); }
  .badge-added, .badge-removed { color: var(--text-secondary); }

  /* Detail rows */
  .detail-row { display: none; }
  .detail-row.open { display: table-row; }
  .detail-content {
    padding: 16px 16px 16px 24px;
    border-left: 3px solid var(--rule);
  }
  .detail-content h4 {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
    margin: 24px 0 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--rule);
  }
  .detail-content h4:first-child { margin-top: 0; }
  .detail-content table { margin: 8px 0 16px; font-size: 14px; table-layout: fixed; width: 100%; }
  .detail-content td, .detail-content th { padding: 8px; }
  .detail-content .text-cell { overflow: hidden; text-overflow: ellipsis; }
  .detail-content .col-code { width: 180px; }
  .detail-content .col-status { width: 100px; }
  .detail-content .col-sim { width: 70px; text-align: right; }
  .detail-content .col-text { min-width: 150px; }

  /* Clickable cells */
  .clickable { cursor: pointer; text-align: center; }
  .clickable:hover { opacity: 0.7; }
</style>
</head>
<body>

<h1>Questionnaire Comparison Report</h1>
<p class="subtitle" id="subtitle">Flexible survey comparison</p>

<div id="app">
  <div class="loading">Loading data...</div>
</div>

<script>
const ARROW = '\u2192';

let DATA = null;
let currentLanguage = 'de-ch';
let currentFilter = 'all';
let searchTerm = '';
let currentReference = '';
let selectedTargets = [];
let hideUnmatched = true;

async function loadData() {
  try {
    const response = await fetch('data.json');
    if (!response.ok) throw new Error('Failed to load data.json');
    DATA = await response.json();
    currentLanguage = DATA.meta.languages.includes('de-ch') ? 'de-ch' : DATA.meta.languages[0];
    currentReference = DATA.meta.default_reference || DATA.meta.sources[0];
    selectedTargets = DATA.meta.sources.filter(s => s !== currentReference);
    render();
  } catch (err) {
    document.getElementById('app').innerHTML = `<div class="error">Error loading data: ${err.message}</div>`;
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function truncate(text, len) {
  if (!text) return '';
  return text.length > len ? text.slice(0, len) + '...' : text;
}

function getDiffKey(refSource, targetSource) {
  return refSource + ARROW + targetSource;
}

function getDiffsForPair(refSource, targetSource) {
  return DATA.diffs[getDiffKey(refSource, targetSource)] || {};
}

function getWorstStatus(code) {
  let worst = 'identical';
  const priority = ['structure_changed', 'text_changed', 'added', 'removed', 'identical'];
  for (const target of selectedTargets) {
    const pairDiffs = getDiffsForPair(currentReference, target);
    const diff = pairDiffs[code];
    if (diff && priority.indexOf(diff.status) < priority.indexOf(worst)) {
      worst = diff.status;
    }
  }
  return worst;
}

function isMatchedInAnyTarget(code) {
  for (const target of selectedTargets) {
    if (DATA.questions[target] && DATA.questions[target][code]) return true;
  }
  return false;
}

function shouldShowRow(code) {
  if (hideUnmatched && !isMatchedInAnyTarget(code)) return false;
  const status = getWorstStatus(code);
  if (currentFilter === 'all') return true;
  if (currentFilter === 'different') return status === 'text_changed' || status === 'structure_changed';
  return status === currentFilter;
}

function matchesSearch(code) {
  if (!searchTerm) return true;
  const term = searchTerm.toLowerCase();
  if (code.toLowerCase().includes(term)) return true;
  const refQ = DATA.questions[currentReference] ? DATA.questions[currentReference][code] : null;
  if (refQ) {
    for (const text of Object.values(refQ.texts)) {
      if (text.toLowerCase().includes(term)) return true;
    }
  }
  return false;
}

function getShortName(source) {
  return DATA.meta.short_names[source] || source;
}

function renderSummary() {
  const counts = { identical: 0, text_changed: 0, structure_changed: 0, added: 0, removed: 0 };
  const allCodes = new Set();
  for (const source of DATA.meta.sources) {
    const qs = DATA.questions[source];
    if (qs) for (const code of Object.keys(qs)) allCodes.add(code);
  }
  let visibleCount = 0;
  for (const code of allCodes) {
    if (hideUnmatched && !isMatchedInAnyTarget(code)) continue;
    const worst = getWorstStatus(code);
    counts[worst] = (counts[worst] || 0) + 1;
    visibleCount++;
  }

  const changedCount = counts.text_changed + counts.structure_changed;
  const missingCount = counts.added + counts.removed;
  const identicalPct = visibleCount > 0 ? (counts.identical / visibleCount * 100) : 0;
  const changedPct = visibleCount > 0 ? (changedCount / visibleCount * 100) : 0;
  const missingPct = visibleCount > 0 ? (missingCount / visibleCount * 100) : 0;

  return `
    <div class="summary">
      <div class="summary-bar">
        <div class="bar-identical" style="width:${identicalPct.toFixed(1)}%"></div>
        <div class="bar-changed" style="width:${changedPct.toFixed(1)}%"></div>
        <div class="bar-missing" style="width:${missingPct.toFixed(1)}%"></div>
      </div>
      <p class="summary-text">${visibleCount} total &mdash; ${counts.identical} identical, ${counts.text_changed} text changed, ${counts.structure_changed} structure changed, ${missingCount} added/removed</p>
    </div>
  `;
}

function renderFilters() {
  const langOptions = DATA.meta.languages.map(l =>
    `<option value="${l}"${l === currentLanguage ? ' selected' : ''}>${l}</option>`
  ).join('');

  const refOptions = DATA.meta.sources.map(s =>
    `<option value="${escapeHtml(s)}"${s === currentReference ? ' selected' : ''}>${escapeHtml(getShortName(s))}</option>`
  ).join('');

  const targetCheckboxes = DATA.meta.sources
    .filter(s => s !== currentReference)
    .map(s => {
      const checked = selectedTargets.includes(s) ? ' checked' : '';
      const id = 'target-' + s.replace(/[^a-zA-Z0-9]/g, '_');
      return `<span class="target-option">
        <input type="checkbox" id="${id}" value="${escapeHtml(s)}"${checked}>
        <label for="${id}">${escapeHtml(getShortName(s))}</label>
      </span>`;
    }).join('');

  return `
    <div class="toolbar">
      <div class="toolbar-primary">
        <label for="reference-selector">Reference</label>
        <select id="reference-selector">${refOptions}</select>
        <label>Compare against</label>
        ${targetCheckboxes}
      </div>
      <div class="toolbar-secondary">
        <label for="language-filter">Language</label>
        <select id="language-filter">${langOptions}</select>
        <label for="status-filter">Filter</label>
        <select id="status-filter">
          <option value="all"${currentFilter === 'all' ? ' selected' : ''}>All</option>
          <option value="identical"${currentFilter === 'identical' ? ' selected' : ''}>Identical</option>
          <option value="different"${currentFilter === 'different' ? ' selected' : ''}>Changed</option>
          <option value="removed"${currentFilter === 'removed' ? ' selected' : ''}>Not in Survey</option>
        </select>
        <label for="search-box">Search</label>
        <input type="text" id="search-box" placeholder="Question code or text..." value="${escapeHtml(searchTerm)}">
        <label class="checkbox-label">
          <input type="checkbox" id="hide-unmatched" ${hideUnmatched ? 'checked' : ''}>
          Only matched
        </label>
      </div>
    </div>
  `;
}

function renderQuestionRow(code) {
  const refQ = DATA.questions[currentReference] ? DATA.questions[currentReference][code] : null;
  const worstStatus = getWorstStatus(code);

  const refText = refQ ? escapeHtml(truncate(refQ.texts[currentLanguage] || '', 120)) : '\u2014';
  const elementType = refQ ? refQ.element_type : '\u2014';

  // Determine row class for left border
  let rowClass = 'question-row';
  if (worstStatus === 'text_changed' || worstStatus === 'structure_changed') {
    rowClass += ' row-changed';
  } else if (worstStatus === 'added' || worstStatus === 'removed') {
    rowClass += ' row-missing';
  }

  let surveyCells = '';
  for (const target of selectedTargets) {
    const pairDiffs = getDiffsForPair(currentReference, target);
    const diff = pairDiffs[code];
    if (diff) {
      const label = diff.status === 'removed' ? '\u2014' :
        (diff.status === 'text_changed' || diff.status === 'structure_changed') ? 'changed' : diff.status;
      surveyCells += `<td class="clickable" onclick="toggleDetail('${code}')">
        <span class="status-badge badge-${diff.status}">${label}</span>
      </td>`;
    } else {
      surveyCells += `<td class="clickable" onclick="toggleDetail('${code}')"><span class="status-badge badge-removed">\u2014</span></td>`;
    }
  }

  return `
    <tr class="${rowClass}" data-code="${code}" data-status="${worstStatus}">
      <td class="code-col">${escapeHtml(code)}</td>
      <td class="type-col">${escapeHtml(elementType)}</td>
      <td class="text-col">${refText || '\u2014'}</td>
      ${surveyCells}
    </tr>
    <tr class="detail-row" id="detail-${code}">
      <td colspan="${3 + selectedTargets.length}">
        <div class="detail-content">${renderDetailContent(code)}</div>
      </td>
    </tr>
  `;
}

function renderDetailContent(code) {
  const refQ = DATA.questions[currentReference] ? DATA.questions[currentReference][code] : null;
  const refShort = getShortName(currentReference);
  let html = '';

  // Question Text Section
  html += '<h4>Question</h4><table><colgroup><col class="col-status"><col class="col-sim"><col class="col-text">';
  for (const target of selectedTargets) html += '<col class="col-text">';
  html += `</colgroup><tr><th>Status</th><th>Similarity</th><th>${escapeHtml(refShort)} Text</th>`;
  for (const target of selectedTargets) {
    html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
  }
  html += '</tr>';

  const refText = refQ ? (refQ.texts[currentLanguage] || '') : '';
  let worstStatus = 'exact';
  let worstSim = 1.0;
  let surveyTexts = [];

  for (const target of selectedTargets) {
    const pairDiffs = getDiffsForPair(currentReference, target);
    const diff = pairDiffs[code];
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    let surveyText = '';

    if (diff && diff.text_diffs && diff.text_diffs.length > 0) {
      for (const td of diff.text_diffs) {
        if (td.language === currentLanguage) {
          surveyText = td.new_text || '';
          if (td.status === 'different') worstStatus = 'different';
          else if (['similar', 'added', 'removed'].includes(td.status) && worstStatus === 'exact') worstStatus = td.status;
          if (td.similarity < worstSim) worstSim = td.similarity;
        }
      }
    } else if (diff && diff.status === 'removed') {
      worstStatus = 'removed';
      worstSim = 0;
    } else if (diff && diff.status === 'added') {
      surveyText = targetQ ? (targetQ.texts[currentLanguage] || '') : '';
      worstStatus = 'added';
      worstSim = 0;
    }
    surveyTexts.push(surveyText);
  }

  html += `<tr><td><span class="status-badge badge-${worstStatus}">${worstStatus}</span></td>`;
  html += `<td>${worstSim > 0 ? Math.round(worstSim * 100) + '%' : '\u2014'}</td>`;
  html += `<td class="text-cell">${escapeHtml(truncate(refText, 150)) || '\u2014'}</td>`;
  for (const st of surveyTexts) {
    html += `<td class="text-cell">${escapeHtml(truncate(st, 150)) || '\u2014'}</td>`;
  }
  html += '</tr></table>';

  // Answer Options Section
  const allChoiceCodes = new Set();
  if (refQ && refQ.choices) {
    for (const c of refQ.choices) allChoiceCodes.add(c.code);
  }
  for (const target of selectedTargets) {
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    if (targetQ && targetQ.choices) {
      for (const c of targetQ.choices) allChoiceCodes.add(c.code);
    }
  }

  if (allChoiceCodes.size > 0) {
    html += '<h4>Answer Options</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const target of selectedTargets) html += '<col class="col-text">';
    html += `</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>${escapeHtml(refShort)} Text</th>`;
    for (const target of selectedTargets) {
      html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
    }
    html += '</tr>';

    for (const choiceCode of allChoiceCodes) {
      let refChoiceText = '';
      if (refQ && refQ.choices) {
        const mc = refQ.choices.find(c => c.code === choiceCode);
        if (mc) refChoiceText = mc.texts[currentLanguage] || '';
      }

      let langStatus = 'exact';
      let langSim = 1.0;
      for (const target of selectedTargets) {
        const pairDiffs = getDiffsForPair(currentReference, target);
        const diff = pairDiffs[code];
        if (diff && diff.choice_diffs) {
          for (const cd of diff.choice_diffs) {
            if (cd.code === choiceCode) {
              if (['added', 'removed'].includes(cd.status)) {
                langStatus = cd.status;
              } else if (cd.text_diffs) {
                for (const td of cd.text_diffs) {
                  if (td.language === currentLanguage) {
                    if (td.status === 'different') langStatus = 'different';
                    else if (['similar', 'added', 'removed'].includes(td.status) && langStatus === 'exact') langStatus = td.status;
                    if (td.similarity < langSim) langSim = td.similarity;
                  }
                }
              }
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(choiceCode)}</td>`;
      html += `<td><span class="status-badge badge-${langStatus}">${langStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(langSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(refChoiceText, 100)) || '\u2014'}</td>`;

      for (const target of selectedTargets) {
        let targetChoiceText = '';
        const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
        if (targetQ && targetQ.choices) {
          const sc = targetQ.choices.find(c => c.code === choiceCode);
          if (sc) targetChoiceText = sc.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(targetChoiceText, 100)) || '\u2014'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  // Matrix Rows Section
  const allRowCodes = new Set();
  if (refQ && refQ.matrix_rows) {
    for (const r of refQ.matrix_rows) allRowCodes.add(r.code);
  }
  for (const target of selectedTargets) {
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    if (targetQ && targetQ.matrix_rows) {
      for (const r of targetQ.matrix_rows) allRowCodes.add(r.code);
    }
  }

  if (allRowCodes.size > 0) {
    html += '<h4>Matrix Rows</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const target of selectedTargets) html += '<col class="col-text">';
    html += `</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>${escapeHtml(refShort)} Text</th>`;
    for (const target of selectedTargets) {
      html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
    }
    html += '</tr>';

    for (const rowCode of allRowCodes) {
      let refRowText = '';
      if (refQ && refQ.matrix_rows) {
        const mr = refQ.matrix_rows.find(r => r.code === rowCode);
        if (mr) refRowText = mr.texts[currentLanguage] || '';
      }

      let langStatus = 'exact';
      let langSim = 1.0;
      for (const target of selectedTargets) {
        const pairDiffs = getDiffsForPair(currentReference, target);
        const diff = pairDiffs[code];
        if (diff && diff.matrix_row_diffs) {
          for (const rd of diff.matrix_row_diffs) {
            if (rd.code === rowCode) {
              if (['added', 'removed'].includes(rd.status)) {
                langStatus = rd.status;
              } else if (rd.text_diffs) {
                for (const td of rd.text_diffs) {
                  if (td.language === currentLanguage) {
                    if (td.status === 'different') langStatus = 'different';
                    else if (['similar', 'added', 'removed'].includes(td.status) && langStatus === 'exact') langStatus = td.status;
                    if (td.similarity < langSim) langSim = td.similarity;
                  }
                }
              }
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(rowCode)}</td>`;
      html += `<td><span class="status-badge badge-${langStatus}">${langStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(langSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(refRowText, 100)) || '\u2014'}</td>`;

      for (const target of selectedTargets) {
        let targetRowText = '';
        const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
        if (targetQ && targetQ.matrix_rows) {
          const sr = targetQ.matrix_rows.find(r => r.code === rowCode);
          if (sr) targetRowText = sr.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(targetRowText, 100)) || '\u2014'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  // Matrix Columns Section
  const allColCodes = new Set();
  if (refQ && refQ.matrix_columns) {
    for (const c of refQ.matrix_columns) allColCodes.add(c.code);
  }
  for (const target of selectedTargets) {
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    if (targetQ && targetQ.matrix_columns) {
      for (const c of targetQ.matrix_columns) allColCodes.add(c.code);
    }
  }

  if (allColCodes.size > 0) {
    html += '<h4>Matrix Columns</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const target of selectedTargets) html += '<col class="col-text">';
    html += `</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>${escapeHtml(refShort)} Text</th>`;
    for (const target of selectedTargets) {
      html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
    }
    html += '</tr>';

    for (const colCode of allColCodes) {
      let refColText = '';
      if (refQ && refQ.matrix_columns) {
        const mc = refQ.matrix_columns.find(c => c.code === colCode);
        if (mc) refColText = mc.texts[currentLanguage] || '';
      }

      let langStatus = 'exact';
      let langSim = 1.0;
      for (const target of selectedTargets) {
        const pairDiffs = getDiffsForPair(currentReference, target);
        const diff = pairDiffs[code];
        if (diff && diff.matrix_column_diffs) {
          for (const cd of diff.matrix_column_diffs) {
            if (cd.code === colCode) {
              if (['added', 'removed'].includes(cd.status)) {
                langStatus = cd.status;
              } else if (cd.text_diffs) {
                for (const td of cd.text_diffs) {
                  if (td.language === currentLanguage) {
                    if (td.status === 'different') langStatus = 'different';
                    else if (['similar', 'added', 'removed'].includes(td.status) && langStatus === 'exact') langStatus = td.status;
                    if (td.similarity < langSim) langSim = td.similarity;
                  }
                }
              }
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(colCode)}</td>`;
      html += `<td><span class="status-badge badge-${langStatus}">${langStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(langSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(refColText, 100)) || '\u2014'}</td>`;

      for (const target of selectedTargets) {
        let targetColText = '';
        const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
        if (targetQ && targetQ.matrix_columns) {
          const sc = targetQ.matrix_columns.find(c => c.code === colCode);
          if (sc) targetColText = sc.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(targetColText, 100)) || '\u2014'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  return html;
}

function getSectionAliasHtml(sectionName) {
  const aliases = DATA.meta.section_aliases;
  if (!aliases || !aliases[sectionName]) return '';
  const aliasList = aliases[sectionName];
  return `<span class="section-alias" title="Also known as: ${escapeHtml(aliasList.join(', '))}">\u2190 ${escapeHtml(aliasList.join(', '))}</span>`;
}

function renderSection(sectionName, codes) {
  const filteredCodes = codes.filter(code => shouldShowRow(code) && matchesSearch(code));
  if (filteredCodes.length === 0) return '';

  const surveyHeaders = selectedTargets.map(s =>
    `<th class="survey-col">${escapeHtml(getShortName(s))}</th>`
  ).join('');

  const refShort = getShortName(currentReference);
  const rows = filteredCodes.map(code => renderQuestionRow(code)).join('');
  const aliasHtml = getSectionAliasHtml(sectionName);

  return `
    <div class="section-group" data-section="${escapeHtml(sectionName)}">
      <div class="section-title" onclick="toggleSection(this)">
        <span>${escapeHtml(sectionName)}${aliasHtml}</span>
        <span class="section-count">${filteredCodes.length} questions</span>
      </div>
      <table>
        <thead>
          <tr>
            <th class="code-col">Code</th>
            <th class="type-col">Type</th>
            <th class="text-col">${escapeHtml(refShort)} Text</th>
            ${surveyHeaders}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function render() {
  if (selectedTargets.length === 0) {
    document.getElementById('app').innerHTML = renderFilters() +
      '<div style="text-align:center;padding:48px;color:var(--text-secondary)">Select at least one target survey to compare against.</div>';
    document.getElementById('subtitle').textContent =
      `Reference: ${getShortName(currentReference)}`;
    attachEventListeners();
    return;
  }

  document.getElementById('subtitle').textContent =
    `Reference: ${getShortName(currentReference)} \u2192 comparing against: ${selectedTargets.map(getShortName).join(', ')}`;

  let html = renderSummary() + renderFilters();

  for (const [sectionName, codes] of Object.entries(DATA.meta.sections)) {
    html += renderSection(sectionName, codes);
  }

  document.getElementById('app').innerHTML = html;
  attachEventListeners();
}

function attachEventListeners() {
  document.getElementById('reference-selector').addEventListener('change', function() {
    currentReference = this.value;
    selectedTargets = selectedTargets.filter(s => s !== currentReference);
    render();
  });

  document.getElementById('language-filter').addEventListener('change', function() {
    currentLanguage = this.value;
    render();
  });

  document.getElementById('status-filter').addEventListener('change', function() {
    currentFilter = this.value;
    render();
  });

  document.getElementById('search-box').addEventListener('input', function() {
    searchTerm = this.value;
    render();
  });

  document.getElementById('hide-unmatched').addEventListener('change', function() {
    hideUnmatched = this.checked;
    render();
  });

  const checkboxes = document.querySelectorAll('.target-option input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      selectedTargets = [];
      document.querySelectorAll('.target-option input[type="checkbox"]:checked').forEach(el => {
        selectedTargets.push(el.value);
      });
      render();
    });
  });
}

function toggleDetail(code) {
  const row = document.getElementById('detail-' + code);
  if (row) row.classList.toggle('open');
}

function toggleSection(el) {
  const table = el.nextElementSibling;
  if (table) table.style.display = table.style.display === 'none' ? '' : 'none';
}

loadData();
</script>

</body>
</html>
