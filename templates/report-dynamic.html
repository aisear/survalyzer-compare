<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survalyzer Questionnaire Comparison</title>
<style>
  :root {
    --green: #d4edda;
    --green-border: #28a745;
    --blue: #d1ecf1;
    --blue-border: #17a2b8;
    --grey: #e9e9e9;
    --grey-border: #aaa;
    --lightgrey: #f5f5f5;
    --lightgrey-border: #ccc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; font-size: 14px; color: #333; padding: 20px; background: #fafafa; }
  h1 { margin-bottom: 8px; }
  .subtitle { margin-bottom: 16px; color: #666; font-size: 13px; }
  .loading { text-align: center; padding: 40px; color: #666; }
  .error { text-align: center; padding: 40px; color: #cc0000; }

  .summary { margin-bottom: 20px; padding: 12px 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; display: flex; gap: 24px; flex-wrap: wrap; }
  .summary .stat { text-align: center; }
  .summary .stat .num { font-size: 24px; font-weight: 700; }
  .summary .stat .label { font-size: 12px; color: #666; text-transform: uppercase; }

  .legend { margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
  .legend span { padding: 3px 10px; border-radius: 4px; font-size: 12px; }
  .legend .green { background: var(--green); border: 1px solid var(--green-border); }
  .legend .blue { background: var(--blue); border: 1px solid var(--blue-border); }
  .legend .grey { background: var(--grey); border: 1px solid var(--grey-border); }

  .filter-bar { margin-bottom: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .filter-bar label { font-weight: 600; }
  .filter-bar select, .filter-bar input { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }

  .target-selector { margin-bottom: 16px; padding: 10px 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
  .target-selector label.group-label { font-weight: 600; margin-right: 4px; }
  .target-selector .target-option { display: flex; align-items: center; gap: 4px; }
  .target-selector .target-option input { cursor: pointer; }
  .target-selector .target-option label { cursor: pointer; font-size: 13px; }

  .section-group { margin-bottom: 24px; }
  .section-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; padding: 6px 12px; background: #e8e8e8; border-radius: 4px; cursor: pointer; }
  .section-title:hover { background: #ddd; }
  .section-alias { font-size: 11px; color: #888; font-weight: normal; margin-left: 8px; }

  table { width: 100%; border-collapse: collapse; background: #fff; font-size: 12px; }
  th, td { padding: 8px 10px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; border-left: none; border-right: none; text-align: left; vertical-align: top; }
  th { background: #f5f5f5; font-weight: 600; position: sticky; top: 0; z-index: 2; }
  th.survey-col { font-size: 11px; min-width: 80px; max-width: 120px; }
  .code-col { width: 200px; }
  .type-col { width: 110px; }
  .text-col { min-width: 200px; }

  .cell-green { background: var(--green); }
  .cell-blue { background: var(--blue); }
  .cell-grey { background: var(--grey); }
  .cell-lightgrey { background: var(--lightgrey); }

  .status-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge-identical { background: var(--green); color: #155724; }
  .badge-exact { background: var(--green); color: #155724; }
  .badge-different { background: var(--blue); color: #0c5460; }
  .badge-text_changed { background: var(--blue); color: #0c5460; }
  .badge-similar { background: var(--blue); color: #0c5460; }
  .badge-structure_changed { background: var(--blue); color: #0c5460; }
  .badge-added { background: var(--grey); color: #333; }
  .badge-removed { background: transparent; color: #999; font-weight: normal; }

  .detail-row { display: none; }
  .detail-row.open { display: table-row; }
  .detail-content { padding: 12px 16px; background: #fefefe; }
  .detail-content h4 { margin: 16px 0 8px; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
  .detail-content h4:first-child { margin-top: 0; }
  .detail-content table { margin: 4px 0 12px; font-size: 12px; table-layout: fixed; width: 100%; }
  .detail-content td, .detail-content th { padding: 4px 8px; }
  .detail-content .text-cell { overflow: hidden; text-overflow: ellipsis; }
  .detail-content .col-code { width: 200px; }
  .detail-content .col-status { width: 100px; }
  .detail-content .col-sim { width: 70px; text-align: right; }
  .detail-content .col-text { min-width: 150px; }

  .clickable { cursor: pointer; }
  .clickable:hover { filter: brightness(0.95); }
</style>
</head>
<body>

<h1>Questionnaire Comparison Report</h1>
<p class="subtitle" id="subtitle">Flexible survey comparison</p>

<div id="app">
  <div class="loading">Loading data...</div>
</div>

<script>
const STATUS_COLOR = {
  identical: 'green',
  text_changed: 'blue',
  structure_changed: 'blue',
  added: 'grey',
  removed: 'lightgrey'
};

const ARROW = '\u2192';

let DATA = null;
let currentLanguage = 'de-ch';
let currentFilter = 'all';
let searchTerm = '';
let currentReference = '';  // selected reference source
let selectedTargets = [];   // selected target sources to compare against

async function loadData() {
  try {
    const response = await fetch('data.json');
    if (!response.ok) throw new Error('Failed to load data.json');
    DATA = await response.json();
    currentLanguage = DATA.meta.languages.includes('de-ch') ? 'de-ch' : DATA.meta.languages[0];
    currentReference = DATA.meta.default_reference || DATA.meta.sources[0];
    selectedTargets = DATA.meta.sources.filter(s => s !== currentReference);
    render();
  } catch (err) {
    document.getElementById('app').innerHTML = `<div class="error">Error loading data: ${err.message}</div>`;
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function truncate(text, len) {
  if (!text) return '';
  return text.length > len ? text.slice(0, len) + '...' : text;
}

function getDiffKey(refSource, targetSource) {
  return refSource + ARROW + targetSource;
}

function getDiffsForPair(refSource, targetSource) {
  return DATA.diffs[getDiffKey(refSource, targetSource)] || {};
}

function getWorstStatus(code) {
  let worst = 'identical';
  const priority = ['structure_changed', 'text_changed', 'added', 'removed', 'identical'];
  for (const target of selectedTargets) {
    const pairDiffs = getDiffsForPair(currentReference, target);
    const diff = pairDiffs[code];
    if (diff && priority.indexOf(diff.status) < priority.indexOf(worst)) {
      worst = diff.status;
    }
  }
  return worst;
}

function shouldShowRow(code) {
  const status = getWorstStatus(code);
  if (currentFilter === 'all') return true;
  if (currentFilter === 'different') return status === 'text_changed' || status === 'structure_changed';
  return status === currentFilter;
}

function matchesSearch(code) {
  if (!searchTerm) return true;
  const term = searchTerm.toLowerCase();
  if (code.toLowerCase().includes(term)) return true;
  const refQ = DATA.questions[currentReference] ? DATA.questions[currentReference][code] : null;
  if (refQ) {
    for (const text of Object.values(refQ.texts)) {
      if (text.toLowerCase().includes(term)) return true;
    }
  }
  return false;
}

function getShortName(source) {
  return DATA.meta.short_names[source] || source;
}

function renderSummary() {
  // Compute summary stats dynamically based on current reference/targets
  const counts = { identical: 0, text_changed: 0, structure_changed: 0, added: 0, removed: 0 };
  const allCodes = new Set();
  for (const source of DATA.meta.sources) {
    const qs = DATA.questions[source];
    if (qs) for (const code of Object.keys(qs)) allCodes.add(code);
  }
  for (const code of allCodes) {
    const worst = getWorstStatus(code);
    counts[worst] = (counts[worst] || 0) + 1;
  }

  return `
    <div class="summary">
      <div class="stat"><div class="num">${allCodes.size}</div><div class="label">Total</div></div>
      <div class="stat"><div class="num">${counts.identical}</div><div class="label">Identical</div></div>
      <div class="stat"><div class="num">${counts.text_changed}</div><div class="label">Text Changed</div></div>
      <div class="stat"><div class="num">${counts.structure_changed}</div><div class="label">Structure Changed</div></div>
      <div class="stat"><div class="num">${counts.added}</div><div class="label">Added</div></div>
      <div class="stat"><div class="num">${counts.removed}</div><div class="label">Removed</div></div>
    </div>
    <div class="legend">
      <span class="green">Identical</span>
      <span class="blue">Different</span>
      <span class="grey">Not in survey</span>
    </div>
  `;
}

function renderReferenceSelector() {
  const options = DATA.meta.sources.map(s =>
    `<option value="${escapeHtml(s)}"${s === currentReference ? ' selected' : ''}>${escapeHtml(getShortName(s))}</option>`
  ).join('');
  return `
    <label for="reference-selector">Reference:</label>
    <select id="reference-selector">${options}</select>
  `;
}

function renderTargetCheckboxes() {
  const checkboxes = DATA.meta.sources
    .filter(s => s !== currentReference)
    .map(s => {
      const checked = selectedTargets.includes(s) ? ' checked' : '';
      const id = 'target-' + s.replace(/[^a-zA-Z0-9]/g, '_');
      return `<span class="target-option">
        <input type="checkbox" id="${id}" value="${escapeHtml(s)}"${checked}>
        <label for="${id}">${escapeHtml(getShortName(s))}</label>
      </span>`;
    }).join('');
  return `
    <div class="target-selector">
      <label class="group-label">Compare against:</label>
      ${checkboxes}
    </div>
  `;
}

function renderFilters() {
  const langOptions = DATA.meta.languages.map(l =>
    `<option value="${l}"${l === currentLanguage ? ' selected' : ''}>${l}</option>`
  ).join('');
  return `
    <div class="filter-bar">
      ${renderReferenceSelector()}
      <label for="language-filter">Language:</label>
      <select id="language-filter">${langOptions}</select>
      <label for="status-filter">Filter:</label>
      <select id="status-filter">
        <option value="all"${currentFilter === 'all' ? ' selected' : ''}>All</option>
        <option value="identical"${currentFilter === 'identical' ? ' selected' : ''}>Identical</option>
        <option value="different"${currentFilter === 'different' ? ' selected' : ''}>Different</option>
        <option value="removed"${currentFilter === 'removed' ? ' selected' : ''}>Not in Survey</option>
      </select>
      <label for="search-box">Search:</label>
      <input type="text" id="search-box" placeholder="Question code or text..." value="${escapeHtml(searchTerm)}">
    </div>
    ${renderTargetCheckboxes()}
  `;
}

function renderQuestionRow(code) {
  const refQ = DATA.questions[currentReference] ? DATA.questions[currentReference][code] : null;
  const worstStatus = getWorstStatus(code);

  const refText = refQ ? escapeHtml(truncate(refQ.texts[currentLanguage] || '', 120)) : '\u2014';
  const elementType = refQ ? refQ.element_type : '\u2014';

  let surveyCells = '';
  for (const target of selectedTargets) {
    const pairDiffs = getDiffsForPair(currentReference, target);
    const diff = pairDiffs[code];
    if (diff) {
      const label = diff.status === 'removed' ? '\u2014' :
        (diff.status === 'text_changed' || diff.status === 'structure_changed') ? 'different' : diff.status;
      surveyCells += `<td class="clickable" onclick="toggleDetail('${code}')">
        <span class="status-badge badge-${diff.status}">${label}</span>
      </td>`;
    } else {
      surveyCells += `<td><span class="status-badge badge-removed">\u2014</span></td>`;
    }
  }

  return `
    <tr class="question-row" data-code="${code}" data-status="${worstStatus}">
      <td class="code-col">${escapeHtml(code)}</td>
      <td class="type-col">${escapeHtml(elementType)}</td>
      <td class="text-col">${refText || '\u2014'}</td>
      ${surveyCells}
    </tr>
    <tr class="detail-row" id="detail-${code}">
      <td colspan="${3 + selectedTargets.length}">
        <div class="detail-content">${renderDetailContent(code)}</div>
      </td>
    </tr>
  `;
}

function renderDetailContent(code) {
  const refQ = DATA.questions[currentReference] ? DATA.questions[currentReference][code] : null;
  const refShort = getShortName(currentReference);
  let html = '';

  // Question Text Section
  html += '<h4>Question</h4><table><colgroup><col class="col-status"><col class="col-sim"><col class="col-text">';
  for (const target of selectedTargets) html += '<col class="col-text">';
  html += `</colgroup><tr><th>Status</th><th>Similarity</th><th>${escapeHtml(refShort)} Text</th>`;
  for (const target of selectedTargets) {
    html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
  }
  html += '</tr>';

  const refText = refQ ? (refQ.texts[currentLanguage] || '') : '';
  let worstStatus = 'exact';
  let worstSim = 1.0;
  let surveyTexts = [];

  for (const target of selectedTargets) {
    const pairDiffs = getDiffsForPair(currentReference, target);
    const diff = pairDiffs[code];
    let surveyText = '';
    if (diff && diff.text_diffs) {
      for (const td of diff.text_diffs) {
        if (td.language === currentLanguage) {
          surveyText = td.new_text || '';
          if (td.status === 'different') worstStatus = 'different';
          else if (['similar', 'added', 'removed'].includes(td.status) && worstStatus === 'exact') worstStatus = td.status;
          if (td.similarity < worstSim) worstSim = td.similarity;
        }
      }
    }
    surveyTexts.push(surveyText);
  }

  html += `<tr><td><span class="status-badge badge-${worstStatus}">${worstStatus}</span></td>`;
  html += `<td>${Math.round(worstSim * 100)}%</td>`;
  html += `<td class="text-cell">${escapeHtml(truncate(refText, 150)) || '\u2014'}</td>`;
  for (const st of surveyTexts) {
    html += `<td class="text-cell">${escapeHtml(truncate(st, 150)) || '\u2014'}</td>`;
  }
  html += '</tr></table>';

  // Answer Options Section
  const allChoiceCodes = new Set();
  if (refQ && refQ.choices) {
    for (const c of refQ.choices) allChoiceCodes.add(c.code);
  }
  for (const target of selectedTargets) {
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    if (targetQ && targetQ.choices) {
      for (const c of targetQ.choices) allChoiceCodes.add(c.code);
    }
  }

  if (allChoiceCodes.size > 0) {
    html += '<h4>Answer Options</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const target of selectedTargets) html += '<col class="col-text">';
    html += `</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>${escapeHtml(refShort)} Text</th>`;
    for (const target of selectedTargets) {
      html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
    }
    html += '</tr>';

    for (const choiceCode of allChoiceCodes) {
      let refChoiceText = '';
      if (refQ && refQ.choices) {
        const mc = refQ.choices.find(c => c.code === choiceCode);
        if (mc) refChoiceText = mc.texts[currentLanguage] || '';
      }

      let langStatus = 'exact';
      let langSim = 1.0;
      for (const target of selectedTargets) {
        const pairDiffs = getDiffsForPair(currentReference, target);
        const diff = pairDiffs[code];
        if (diff && diff.choice_diffs) {
          for (const cd of diff.choice_diffs) {
            if (cd.code === choiceCode) {
              if (['added', 'removed'].includes(cd.status)) {
                langStatus = cd.status;
              } else if (cd.text_diffs) {
                for (const td of cd.text_diffs) {
                  if (td.language === currentLanguage) {
                    if (td.status === 'different') langStatus = 'different';
                    else if (['similar', 'added', 'removed'].includes(td.status) && langStatus === 'exact') langStatus = td.status;
                    if (td.similarity < langSim) langSim = td.similarity;
                  }
                }
              }
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(choiceCode)}</td>`;
      html += `<td><span class="status-badge badge-${langStatus}">${langStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(langSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(refChoiceText, 100)) || '\u2014'}</td>`;

      for (const target of selectedTargets) {
        let targetChoiceText = '';
        const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
        if (targetQ && targetQ.choices) {
          const sc = targetQ.choices.find(c => c.code === choiceCode);
          if (sc) targetChoiceText = sc.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(targetChoiceText, 100)) || '\u2014'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  // Matrix Rows Section
  const allRowCodes = new Set();
  if (refQ && refQ.matrix_rows) {
    for (const r of refQ.matrix_rows) allRowCodes.add(r.code);
  }
  for (const target of selectedTargets) {
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    if (targetQ && targetQ.matrix_rows) {
      for (const r of targetQ.matrix_rows) allRowCodes.add(r.code);
    }
  }

  if (allRowCodes.size > 0) {
    html += '<h4>Matrix Rows</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const target of selectedTargets) html += '<col class="col-text">';
    html += `</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>${escapeHtml(refShort)} Text</th>`;
    for (const target of selectedTargets) {
      html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
    }
    html += '</tr>';

    for (const rowCode of allRowCodes) {
      let refRowText = '';
      if (refQ && refQ.matrix_rows) {
        const mr = refQ.matrix_rows.find(r => r.code === rowCode);
        if (mr) refRowText = mr.texts[currentLanguage] || '';
      }

      let langStatus = 'exact';
      let langSim = 1.0;
      for (const target of selectedTargets) {
        const pairDiffs = getDiffsForPair(currentReference, target);
        const diff = pairDiffs[code];
        if (diff && diff.matrix_row_diffs) {
          for (const rd of diff.matrix_row_diffs) {
            if (rd.code === rowCode) {
              if (['added', 'removed'].includes(rd.status)) {
                langStatus = rd.status;
              } else if (rd.text_diffs) {
                for (const td of rd.text_diffs) {
                  if (td.language === currentLanguage) {
                    if (td.status === 'different') langStatus = 'different';
                    else if (['similar', 'added', 'removed'].includes(td.status) && langStatus === 'exact') langStatus = td.status;
                    if (td.similarity < langSim) langSim = td.similarity;
                  }
                }
              }
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(rowCode)}</td>`;
      html += `<td><span class="status-badge badge-${langStatus}">${langStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(langSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(refRowText, 100)) || '\u2014'}</td>`;

      for (const target of selectedTargets) {
        let targetRowText = '';
        const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
        if (targetQ && targetQ.matrix_rows) {
          const sr = targetQ.matrix_rows.find(r => r.code === rowCode);
          if (sr) targetRowText = sr.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(targetRowText, 100)) || '\u2014'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  // Matrix Columns Section
  const allColCodes = new Set();
  if (refQ && refQ.matrix_columns) {
    for (const c of refQ.matrix_columns) allColCodes.add(c.code);
  }
  for (const target of selectedTargets) {
    const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
    if (targetQ && targetQ.matrix_columns) {
      for (const c of targetQ.matrix_columns) allColCodes.add(c.code);
    }
  }

  if (allColCodes.size > 0) {
    html += '<h4>Matrix Columns</h4><table><colgroup><col class="col-code"><col class="col-status"><col class="col-sim"><col class="col-text">';
    for (const target of selectedTargets) html += '<col class="col-text">';
    html += `</colgroup><tr><th>Code</th><th>Status</th><th>Sim</th><th>${escapeHtml(refShort)} Text</th>`;
    for (const target of selectedTargets) {
      html += `<th>${escapeHtml(getShortName(target))} Text</th>`;
    }
    html += '</tr>';

    for (const colCode of allColCodes) {
      let refColText = '';
      if (refQ && refQ.matrix_columns) {
        const mc = refQ.matrix_columns.find(c => c.code === colCode);
        if (mc) refColText = mc.texts[currentLanguage] || '';
      }

      let langStatus = 'exact';
      let langSim = 1.0;
      for (const target of selectedTargets) {
        const pairDiffs = getDiffsForPair(currentReference, target);
        const diff = pairDiffs[code];
        if (diff && diff.matrix_column_diffs) {
          for (const cd of diff.matrix_column_diffs) {
            if (cd.code === colCode) {
              if (['added', 'removed'].includes(cd.status)) {
                langStatus = cd.status;
              } else if (cd.text_diffs) {
                for (const td of cd.text_diffs) {
                  if (td.language === currentLanguage) {
                    if (td.status === 'different') langStatus = 'different';
                    else if (['similar', 'added', 'removed'].includes(td.status) && langStatus === 'exact') langStatus = td.status;
                    if (td.similarity < langSim) langSim = td.similarity;
                  }
                }
              }
            }
          }
        }
      }

      html += `<tr><td class="col-code">${escapeHtml(colCode)}</td>`;
      html += `<td><span class="status-badge badge-${langStatus}">${langStatus.replace('_', ' ')}</span></td>`;
      html += `<td>${Math.round(langSim * 100)}%</td>`;
      html += `<td class="text-cell">${escapeHtml(truncate(refColText, 100)) || '\u2014'}</td>`;

      for (const target of selectedTargets) {
        let targetColText = '';
        const targetQ = DATA.questions[target] ? DATA.questions[target][code] : null;
        if (targetQ && targetQ.matrix_columns) {
          const sc = targetQ.matrix_columns.find(c => c.code === colCode);
          if (sc) targetColText = sc.texts[currentLanguage] || '';
        }
        html += `<td class="text-cell">${escapeHtml(truncate(targetColText, 100)) || '\u2014'}</td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
  }

  return html;
}

function getSectionAliasHtml(sectionName) {
  const aliases = DATA.meta.section_aliases;
  if (!aliases || !aliases[sectionName]) return '';
  const aliasList = aliases[sectionName];
  return `<span class="section-alias" title="Also known as: ${escapeHtml(aliasList.join(', '))}">\u2190 ${escapeHtml(aliasList.join(', '))}</span>`;
}

function renderSection(sectionName, codes) {
  const filteredCodes = codes.filter(code => shouldShowRow(code) && matchesSearch(code));
  if (filteredCodes.length === 0) return '';

  const surveyHeaders = selectedTargets.map(s =>
    `<th class="survey-col">${escapeHtml(getShortName(s))}</th>`
  ).join('');

  const refShort = getShortName(currentReference);
  const rows = filteredCodes.map(code => renderQuestionRow(code)).join('');
  const aliasHtml = getSectionAliasHtml(sectionName);

  return `
    <div class="section-group" data-section="${escapeHtml(sectionName)}">
      <div class="section-title" onclick="toggleSection(this)">${escapeHtml(sectionName)} (${filteredCodes.length} questions)${aliasHtml}</div>
      <table>
        <thead>
          <tr>
            <th class="code-col">Code</th>
            <th class="type-col">Type</th>
            <th class="text-col">${escapeHtml(refShort)} Text</th>
            ${surveyHeaders}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function render() {
  if (selectedTargets.length === 0) {
    document.getElementById('app').innerHTML = renderFilters() +
      '<div style="text-align:center;padding:40px;color:#666">Select at least one target survey to compare against.</div>';
    document.getElementById('subtitle').textContent =
      `Reference: ${getShortName(currentReference)}`;
    attachEventListeners();
    return;
  }

  document.getElementById('subtitle').textContent =
    `Reference: ${getShortName(currentReference)} \u2192 comparing against: ${selectedTargets.map(getShortName).join(', ')}`;

  let html = renderSummary() + renderFilters();

  for (const [sectionName, codes] of Object.entries(DATA.meta.sections)) {
    html += renderSection(sectionName, codes);
  }

  document.getElementById('app').innerHTML = html;
  attachEventListeners();
}

function attachEventListeners() {
  document.getElementById('reference-selector').addEventListener('change', function() {
    currentReference = this.value;
    // Remove the new reference from targets, keep the rest
    selectedTargets = selectedTargets.filter(s => s !== currentReference);
    render();
  });

  document.getElementById('language-filter').addEventListener('change', function() {
    currentLanguage = this.value;
    render();
  });

  document.getElementById('status-filter').addEventListener('change', function() {
    currentFilter = this.value;
    render();
  });

  document.getElementById('search-box').addEventListener('input', function() {
    searchTerm = this.value;
    render();
  });

  // Target checkboxes
  const checkboxes = document.querySelectorAll('.target-option input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      selectedTargets = [];
      document.querySelectorAll('.target-option input[type="checkbox"]:checked').forEach(el => {
        selectedTargets.push(el.value);
      });
      render();
    });
  });
}

function toggleDetail(code) {
  const row = document.getElementById('detail-' + code);
  if (row) row.classList.toggle('open');
}

function toggleSection(el) {
  const table = el.nextElementSibling;
  if (table) table.style.display = table.style.display === 'none' ? '' : 'none';
}

// Load data on page load
loadData();
</script>

</body>
</html>
