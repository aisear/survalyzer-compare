<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survalyzer Questionnaire Comparison</title>
<style>
  :root {
    --green: #c6efce;
    --green-border: #6aa84f;
    --yellow: #fff2cc;
    --yellow-border: #f1c232;
    --red: #f4cccc;
    --red-border: #cc4125;
    --grey: #d9d9d9;
    --grey-border: #999;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px; color: #333; padding: 20px; background: #fafafa; }
  h1 { margin-bottom: 8px; }
  .subtitle { margin-bottom: 16px; color: #666; font-size: 13px; }
  .summary { margin-bottom: 20px; padding: 12px 16px; background: #fff; border: 1px solid #ddd; border-radius: 6px; display: flex; gap: 24px; flex-wrap: wrap; }
  .summary .stat { text-align: center; }
  .summary .stat .num { font-size: 24px; font-weight: 700; }
  .summary .stat .label { font-size: 12px; color: #666; text-transform: uppercase; }
  .legend { margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
  .legend span { padding: 3px 10px; border-radius: 4px; font-size: 12px; }
  .legend .green { background: var(--green); border: 1px solid var(--green-border); }
  .legend .yellow { background: var(--yellow); border: 1px solid var(--yellow-border); }
  .legend .red { background: var(--red); border: 1px solid var(--red-border); }
  .legend .grey { background: var(--grey); border: 1px solid var(--grey-border); }

  .filter-bar { margin-bottom: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  .filter-bar label { font-weight: 600; }
  .filter-bar select, .filter-bar input { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }

  .section-group { margin-bottom: 24px; }
  .section-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; padding: 6px 12px; background: #e8e8e8; border-radius: 4px; cursor: pointer; }
  .section-title:hover { background: #ddd; }

  table { width: 100%; border-collapse: collapse; background: #fff; }
  th, td { padding: 8px 10px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
  th { background: #f5f5f5; font-weight: 600; position: sticky; top: 0; z-index: 2; }
  th.survey-col { font-size: 11px; min-width: 80px; max-width: 120px; word-wrap: break-word; }
  .code-col { width: 140px; font-family: monospace; font-weight: 600; }
  .type-col { width: 110px; font-size: 12px; color: #666; }
  .text-col { min-width: 200px; }

  .cell-green { background: var(--green); }
  .cell-yellow { background: var(--yellow); }
  .cell-red { background: var(--red); }
  .cell-grey { background: var(--grey); }

  .status-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge-identical { background: var(--green); color: #274e13; }
  .badge-exact { background: var(--green); color: #274e13; }
  .badge-text_changed { background: var(--yellow); color: #7f6000; }
  .badge-similar { background: var(--yellow); color: #7f6000; }
  .badge-different { background: var(--red); color: #660000; }
  .badge-structure_changed { background: var(--red); color: #660000; }
  .badge-added { background: var(--grey); color: #333; }
  .badge-removed { background: var(--grey); color: #333; }

  .detail-row { display: none; }
  .detail-row.open { display: table-row; }
  .detail-content { padding: 12px 16px; background: #fefefe; }
  .detail-content h4 { margin: 16px 0 8px; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
  .detail-content h4:first-child { margin-top: 0; }
  .detail-content table { margin: 4px 0 12px; font-size: 13px; }
  .detail-content td, .detail-content th { padding: 4px 8px; }
  .detail-content .text-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }

  .diff-added { color: #274e13; font-weight: 600; }
  .diff-removed { text-decoration: line-through; color: #990000; }
  .diff-changed { color: #7f6000; }

  .clickable { cursor: pointer; }
  .clickable:hover { filter: brightness(0.95); }

  .lang-text { display: none; }
  .lang-text.active { display: inline; }
  .lang-status { display: none; }
</style>
</head>
<body>

<h1>Questionnaire Comparison Report</h1>
<p class="subtitle">Each survey compared against {{ short_names.get(reference_name, reference_name) }}</p>

<div class="summary">
  <div class="stat"><div class="num">{{ total_questions }}</div><div class="label">Total Questions</div></div>
  <div class="stat"><div class="num">{{ status_counts.get('identical', 0) }}</div><div class="label">Identical</div></div>
  <div class="stat"><div class="num">{{ status_counts.get('text_changed', 0) }}</div><div class="label">Text Changed</div></div>
  <div class="stat"><div class="num">{{ status_counts.get('structure_changed', 0) }}</div><div class="label">Structure Changed</div></div>
  <div class="stat"><div class="num">{{ status_counts.get('added', 0) + status_counts.get('removed', 0) }}</div><div class="label">Added / Removed</div></div>
</div>

<div class="legend">
  <span class="green">Identical to {{ short_names.get(reference_name, reference_name) }}</span>
  <span class="yellow">Text changed</span>
  <span class="red">Structure changed</span>
  <span class="grey">Not in {{ short_names.get(reference_name, reference_name) }} / Not in survey</span>
</div>

<div class="filter-bar">
  <label for="language-filter">Language:</label>
  <select id="language-filter">
    {% for lang in languages %}
    <option value="{{ lang }}"{% if lang == default_language %} selected{% endif %}>{{ lang }}</option>
    {% endfor %}
  </select>
  <label for="status-filter">Filter:</label>
  <select id="status-filter">
    <option value="all">All</option>
    <option value="identical">Identical</option>
    <option value="text_changed">Text Changed</option>
    <option value="structure_changed">Structure Changed</option>
    <option value="added">Added (not in {{ short_names.get(reference_name, reference_name) }})</option>
    <option value="removed">Removed (not in survey)</option>
    <option value="changed">Any Change</option>
  </select>
  <label for="search-box">Search:</label>
  <input type="text" id="search-box" placeholder="Question code or text...">
</div>

{% for section in sections %}
<div class="section-group" data-section="{{ section.name }}">
  <div class="section-title" onclick="toggleSection(this)">{{ section.name }} ({{ section.codes | length }} questions)</div>
  <table>
    <thead>
      <tr>
        <th class="code-col">Code</th>
        <th class="type-col">Type</th>
        <th class="text-col">{{ short_names.get(reference_name, reference_name) }} Text</th>
        {% for survey in survey_names %}
        <th class="survey-col">{{ short_names.get(survey, survey) }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    {% for code in section.codes %}
      {% set q_sources = question_index.get(code, {}) %}
      {% set q_ref = q_sources.get(reference_name) %}
      {% set code_diffs = diff_lookup.get(code, {}) %}
      {# Determine worst status for this row #}
      {% set ns = namespace(worst='identical') %}
      {% for survey, qd in code_diffs.items() %}
        {% if qd.status == 'structure_changed' %}{% set ns.worst = 'structure_changed' %}
        {% elif qd.status in ('text_changed',) and ns.worst not in ('structure_changed',) %}{% set ns.worst = 'text_changed' %}
        {% elif qd.status in ('added', 'removed') and ns.worst == 'identical' %}{% set ns.worst = qd.status %}
        {% endif %}
      {% endfor %}
      <tr class="question-row" data-code="{{ code }}" data-status="{{ ns.worst }}">
        <td class="code-col">{{ code }}</td>
        <td class="type-col">{{ q_ref.element_type if q_ref else '—' }}</td>
        <td class="text-col">
          {% if q_ref %}
            {% for lt in q_ref.texts %}
            <span class="lang-text" data-lang="{{ lt.language }}">{{ lt.text | truncate(120) }}</span>
            {% endfor %}
          {% else %}—{% endif %}
        </td>
        {% for survey in survey_names %}
          {% set qd = code_diffs.get(survey) %}
          {% if qd %}
          <td class="cell-{{ status_color.get(qd.status, '') }} clickable" onclick="toggleDetail('{{ code }}')">
            <span class="status-badge badge-{{ qd.status }}">{{ qd.status | replace('_', ' ') }}</span>
          </td>
          {% else %}
          <td class="cell-grey">—</td>
          {% endif %}
        {% endfor %}
      </tr>
      {# Detail / expandable row #}
      <tr class="detail-row" id="detail-{{ code }}">
        <td colspan="{{ 3 + survey_names | length }}">
          <div class="detail-content">
            {# Question Text Section #}
            <h4>Question</h4>
            <table>
              <tr>
                <th>Language</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {% for lang in languages %}
              <tr data-lang="{{ lang }}" class="lang-row">
                <td>{{ lang }}</td>
                {# Collect text diffs for this language across surveys #}
                {% set ref_ns = namespace(text='') %}
                {% if q_ref %}
                  {% for lt in q_ref.texts %}
                    {% if lt.language == lang %}{% set ref_ns.text = lt.text %}{% endif %}
                  {% endfor %}
                {% endif %}
                {# Find worst status for this language #}
                {% set lang_ns = namespace(worst_status='exact', worst_sim=1.0) %}
                {% for survey in survey_names %}
                  {% set qd = code_diffs.get(survey) %}
                  {% if qd and qd.text_diffs %}
                    {% for td in qd.text_diffs %}
                      {% if td.language == lang %}
                        {% if td.status == 'different' %}{% set lang_ns.worst_status = 'different' %}
                        {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst_status == 'exact' %}{% set lang_ns.worst_status = td.status %}{% endif %}
                        {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                <td><span class="status-badge badge-{{ lang_ns.worst_status }}">{{ lang_ns.worst_status }}</span></td>
                <td>{{ "%.0f" | format(lang_ns.worst_sim * 100) }}%</td>
                <td class="text-cell">{{ ref_ns.text | truncate(150) if ref_ns.text else '—' }}</td>
                {% for survey in survey_names %}
                  {% set qd = code_diffs.get(survey) %}
                  {% set survey_ns = namespace(text='') %}
                  {% if qd and qd.text_diffs %}
                    {% for td in qd.text_diffs %}
                      {% if td.language == lang %}{% set survey_ns.text = td.new_text %}{% endif %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">{{ survey_ns.text | truncate(150) if survey_ns.text else '—' }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>

            {# Answer Options Section #}
            {% set has_choices = false %}
            {% for survey in survey_names %}
              {% set qd = code_diffs.get(survey) %}
              {% if qd and qd.choice_diffs %}{% set has_choices = true %}{% endif %}
            {% endfor %}
            {% if has_choices or (q_ref and q_ref.choices) %}
            <h4>Answer Options</h4>
            <table>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {# Collect all choice codes #}
              {% set choice_codes = [] %}
              {% if q_ref %}
                {% for c in q_ref.choices %}
                  {% if c.code not in choice_codes %}{% set _ = choice_codes.append(c.code) %}{% endif %}
                {% endfor %}
              {% endif %}
              {% for survey in survey_names %}
                {% set qd = code_diffs.get(survey) %}
                {% if qd and qd.choice_diffs %}
                  {% for cd in qd.choice_diffs %}
                    {% if cd.code not in choice_codes %}{% set _ = choice_codes.append(cd.code) %}{% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% for choice_code in choice_codes %}
                {# Find reference choice text for each language #}
                {% set ref_choice_texts = {} %}
                {% if q_ref %}
                  {% for c in q_ref.choices %}
                    {% if c.code == choice_code %}
                      {% for lt in c.texts %}
                        {% set _ = ref_choice_texts.__setitem__(lt.language, lt.text) %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {# Find status per language (worst across surveys for each language) #}
                {% set choice_lang_status = {} %}
                {% set choice_lang_sim = {} %}
                {% for lang in languages %}
                  {% set lang_ns = namespace(worst='exact', worst_sim=1.0, has_structural=false) %}
                  {% for survey in survey_names %}
                    {% set qd = code_diffs.get(survey) %}
                    {% if qd and qd.choice_diffs %}
                      {% for cd in qd.choice_diffs %}
                        {% if cd.code == choice_code %}
                          {% if cd.status in ('added', 'removed') %}
                            {% set lang_ns.has_structural = true %}
                            {% set lang_ns.worst = cd.status %}
                          {% elif cd.text_diffs %}
                            {% for td in cd.text_diffs %}
                              {% if td.language == lang %}
                                {% if td.status == 'different' %}{% set lang_ns.worst = 'different' %}
                                {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst == 'exact' %}{% set lang_ns.worst = td.status %}{% endif %}
                                {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% set _ = choice_lang_status.__setitem__(lang, lang_ns.worst) %}
                  {% set _ = choice_lang_sim.__setitem__(lang, lang_ns.worst_sim) %}
                {% endfor %}
              <tr>
                <td>{{ choice_code }}</td>
                <td>
                  {% for lang in languages %}
                  <span class="status-badge badge-{{ choice_lang_status.get(lang, 'exact') }} lang-status" data-lang="{{ lang }}">{{ choice_lang_status.get(lang, 'exact') | replace('_', ' ') }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% for lang in languages %}
                  <span class="lang-status" data-lang="{{ lang }}">{{ "%.0f" | format(choice_lang_sim.get(lang, 1.0) * 100) }}%</span>
                  {% endfor %}
                </td>
                <td class="text-cell">
                  {% for lang in languages %}
                  <span class="lang-text" data-lang="{{ lang }}">{{ ref_choice_texts.get(lang, '') | truncate(100) if ref_choice_texts.get(lang) else '—' }}</span>
                  {% endfor %}
                </td>
                {% for survey in survey_names %}
                  {% set survey_choice_texts = {} %}
                  {% set q_survey = q_sources.get(survey) %}
                  {% if q_survey %}
                    {% for c in q_survey.choices %}
                      {% if c.code == choice_code %}
                        {% for lt in c.texts %}
                          {% set _ = survey_choice_texts.__setitem__(lt.language, lt.text) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">
                    {% for lang in languages %}
                    <span class="lang-text" data-lang="{{ lang }}">{{ survey_choice_texts.get(lang, '') | truncate(100) if survey_choice_texts.get(lang) else '—' }}</span>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}

            {# Matrix Rows Section #}
            {% set has_rows = false %}
            {% for survey in survey_names %}
              {% set qd = code_diffs.get(survey) %}
              {% if qd and qd.matrix_row_diffs %}{% set has_rows = true %}{% endif %}
            {% endfor %}
            {% if has_rows or (q_ref and q_ref.matrix_rows) %}
            <h4>Matrix Rows</h4>
            <table>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {# Collect all row codes #}
              {% set row_codes = [] %}
              {% if q_ref and q_ref.matrix_rows %}
                {% for r in q_ref.matrix_rows %}
                  {% if r.code not in row_codes %}{% set _ = row_codes.append(r.code) %}{% endif %}
                {% endfor %}
              {% endif %}
              {% for survey in survey_names %}
                {% set qd = code_diffs.get(survey) %}
                {% if qd and qd.matrix_row_diffs %}
                  {% for rd in qd.matrix_row_diffs %}
                    {% if rd.code not in row_codes %}{% set _ = row_codes.append(rd.code) %}{% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% for row_code in row_codes %}
                {# Find reference row text for each language #}
                {% set ref_row_texts = {} %}
                {% if q_ref and q_ref.matrix_rows %}
                  {% for r in q_ref.matrix_rows %}
                    {% if r.code == row_code %}
                      {% for lt in r.texts %}
                        {% set _ = ref_row_texts.__setitem__(lt.language, lt.text) %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {# Find status per language (worst across surveys for each language) #}
                {% set row_lang_status = {} %}
                {% set row_lang_sim = {} %}
                {% for lang in languages %}
                  {% set lang_ns = namespace(worst='exact', worst_sim=1.0, has_structural=false) %}
                  {% for survey in survey_names %}
                    {% set qd = code_diffs.get(survey) %}
                    {% if qd and qd.matrix_row_diffs %}
                      {% for rd in qd.matrix_row_diffs %}
                        {% if rd.code == row_code %}
                          {% if rd.status in ('added', 'removed') %}
                            {% set lang_ns.has_structural = true %}
                            {% set lang_ns.worst = rd.status %}
                          {% elif rd.text_diffs %}
                            {% for td in rd.text_diffs %}
                              {% if td.language == lang %}
                                {% if td.status == 'different' %}{% set lang_ns.worst = 'different' %}
                                {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst == 'exact' %}{% set lang_ns.worst = td.status %}{% endif %}
                                {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% set _ = row_lang_status.__setitem__(lang, lang_ns.worst) %}
                  {% set _ = row_lang_sim.__setitem__(lang, lang_ns.worst_sim) %}
                {% endfor %}
              <tr>
                <td>{{ row_code }}</td>
                <td>
                  {% for lang in languages %}
                  <span class="status-badge badge-{{ row_lang_status.get(lang, 'exact') }} lang-status" data-lang="{{ lang }}">{{ row_lang_status.get(lang, 'exact') | replace('_', ' ') }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% for lang in languages %}
                  <span class="lang-status" data-lang="{{ lang }}">{{ "%.0f" | format(row_lang_sim.get(lang, 1.0) * 100) }}%</span>
                  {% endfor %}
                </td>
                <td class="text-cell">
                  {% for lang in languages %}
                  <span class="lang-text" data-lang="{{ lang }}">{{ ref_row_texts.get(lang, '') | truncate(100) if ref_row_texts.get(lang) else '—' }}</span>
                  {% endfor %}
                </td>
                {% for survey in survey_names %}
                  {% set survey_row_texts = {} %}
                  {% set q_survey = q_sources.get(survey) %}
                  {% if q_survey and q_survey.matrix_rows %}
                    {% for r in q_survey.matrix_rows %}
                      {% if r.code == row_code %}
                        {% for lt in r.texts %}
                          {% set _ = survey_row_texts.__setitem__(lt.language, lt.text) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">
                    {% for lang in languages %}
                    <span class="lang-text" data-lang="{{ lang }}">{{ survey_row_texts.get(lang, '') | truncate(100) if survey_row_texts.get(lang) else '—' }}</span>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}

            {# Matrix Columns Section #}
            {% set has_cols = false %}
            {% for survey in survey_names %}
              {% set qd = code_diffs.get(survey) %}
              {% if qd and qd.matrix_column_diffs %}{% set has_cols = true %}{% endif %}
            {% endfor %}
            {% if has_cols or (q_ref and q_ref.matrix_column_groups) %}
            <h4>Matrix Columns</h4>
            <table>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {# Collect all column codes #}
              {% set col_codes = [] %}
              {% if q_ref and q_ref.matrix_column_groups %}
                {% for cg in q_ref.matrix_column_groups %}
                  {% for c in cg.columns %}
                    {% if c.code not in col_codes %}{% set _ = col_codes.append(c.code) %}{% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
              {% for survey in survey_names %}
                {% set qd = code_diffs.get(survey) %}
                {% if qd and qd.matrix_column_diffs %}
                  {% for cd in qd.matrix_column_diffs %}
                    {% if cd.code not in col_codes %}{% set _ = col_codes.append(cd.code) %}{% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% for col_code in col_codes %}
                {# Find reference column text for each language #}
                {% set ref_col_texts = {} %}
                {% if q_ref and q_ref.matrix_column_groups %}
                  {% for cg in q_ref.matrix_column_groups %}
                    {% for c in cg.columns %}
                      {% if c.code == col_code %}
                        {% for lt in c.texts %}
                          {% set _ = ref_col_texts.__setitem__(lt.language, lt.text) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                {% endif %}
                {# Find status per language (worst across surveys for each language) #}
                {% set col_lang_status = {} %}
                {% set col_lang_sim = {} %}
                {% for lang in languages %}
                  {% set lang_ns = namespace(worst='exact', worst_sim=1.0, has_structural=false) %}
                  {% for survey in survey_names %}
                    {% set qd = code_diffs.get(survey) %}
                    {% if qd and qd.matrix_column_diffs %}
                      {% for cd in qd.matrix_column_diffs %}
                        {% if cd.code == col_code %}
                          {% if cd.status in ('added', 'removed') %}
                            {% set lang_ns.has_structural = true %}
                            {% set lang_ns.worst = cd.status %}
                          {% elif cd.text_diffs %}
                            {% for td in cd.text_diffs %}
                              {% if td.language == lang %}
                                {% if td.status == 'different' %}{% set lang_ns.worst = 'different' %}
                                {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst == 'exact' %}{% set lang_ns.worst = td.status %}{% endif %}
                                {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% set _ = col_lang_status.__setitem__(lang, lang_ns.worst) %}
                  {% set _ = col_lang_sim.__setitem__(lang, lang_ns.worst_sim) %}
                {% endfor %}
              <tr>
                <td>{{ col_code }}</td>
                <td>
                  {% for lang in languages %}
                  <span class="status-badge badge-{{ col_lang_status.get(lang, 'exact') }} lang-status" data-lang="{{ lang }}">{{ col_lang_status.get(lang, 'exact') | replace('_', ' ') }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% for lang in languages %}
                  <span class="lang-status" data-lang="{{ lang }}">{{ "%.0f" | format(col_lang_sim.get(lang, 1.0) * 100) }}%</span>
                  {% endfor %}
                </td>
                <td class="text-cell">
                  {% for lang in languages %}
                  <span class="lang-text" data-lang="{{ lang }}">{{ ref_col_texts.get(lang, '') | truncate(100) if ref_col_texts.get(lang) else '—' }}</span>
                  {% endfor %}
                </td>
                {% for survey in survey_names %}
                  {% set survey_col_texts = {} %}
                  {% set q_survey = q_sources.get(survey) %}
                  {% if q_survey and q_survey.matrix_column_groups %}
                    {% for cg in q_survey.matrix_column_groups %}
                      {% for c in cg.columns %}
                        {% if c.code == col_code %}
                          {% for lt in c.texts %}
                            {% set _ = survey_col_texts.__setitem__(lt.language, lt.text) %}
                          {% endfor %}
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">
                    {% for lang in languages %}
                    <span class="lang-text" data-lang="{{ lang }}">{{ survey_col_texts.get(lang, '') | truncate(100) if survey_col_texts.get(lang) else '—' }}</span>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}

          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endfor %}

<script>
function toggleDetail(code) {
  const row = document.getElementById('detail-' + code);
  if (row) row.classList.toggle('open');
}

function toggleSection(el) {
  const table = el.nextElementSibling;
  if (table) table.style.display = table.style.display === 'none' ? '' : 'none';
}

// Language filter - show/hide text spans and status badges based on selected language
function updateLanguageDisplay() {
  const lang = document.getElementById('language-filter').value;
  // Update main table text columns
  document.querySelectorAll('.lang-text').forEach(function(el) {
    el.classList.toggle('active', el.dataset.lang === lang);
  });
  // Update detail table rows
  document.querySelectorAll('.lang-row').forEach(function(row) {
    row.style.display = row.dataset.lang === lang ? '' : 'none';
  });
  // Update language-specific status badges and similarity values
  document.querySelectorAll('.lang-status').forEach(function(el) {
    el.style.display = el.dataset.lang === lang ? '' : 'none';
  });
}

document.getElementById('language-filter').addEventListener('change', updateLanguageDisplay);
// Initialize on load
updateLanguageDisplay();

document.getElementById('status-filter').addEventListener('change', function() {
  const val = this.value;
  document.querySelectorAll('.question-row').forEach(function(row) {
    const status = row.dataset.status;
    let show = true;
    if (val === 'changed') {
      show = status !== 'identical';
    } else if (val !== 'all') {
      show = status === val;
    }
    row.style.display = show ? '' : 'none';
    // Also hide detail row
    const detailRow = document.getElementById('detail-' + row.dataset.code);
    if (detailRow && !show) { detailRow.classList.remove('open'); detailRow.style.display = 'none'; }
    else if (detailRow && show) { detailRow.style.display = ''; }
  });
});

document.getElementById('search-box').addEventListener('input', function() {
  const term = this.value.toLowerCase();
  document.querySelectorAll('.question-row').forEach(function(row) {
    const text = row.textContent.toLowerCase();
    const match = !term || text.includes(term);
    row.style.display = match ? '' : 'none';
    const detailRow = document.getElementById('detail-' + row.dataset.code);
    if (detailRow && !match) { detailRow.classList.remove('open'); detailRow.style.display = 'none'; }
    else if (detailRow && match) { detailRow.style.display = ''; }
  });
});
</script>

</body>
</html>
