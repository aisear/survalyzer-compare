<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survalyzer Questionnaire Comparison</title>
<style>
  :root {
    --accent: #3B6CB4;
    --accent-bg: rgba(59, 108, 180, 0.10);
    --neutral: #E8E5E1;
    --text: #1A1A1A;
    --text-secondary: #777;
    --rule: #E0E0E0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 14px;
    color: var(--text);
    padding: 32px;
    background: #fff;
    line-height: 1.5;
  }

  h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
  .subtitle { font-size: 14px; color: #888; margin-bottom: 48px; }

  /* Summary bar */
  .summary { margin-bottom: 24px; }
  .summary-bar {
    display: flex;
    height: 8px;
    width: 100%;
    border: 1px solid var(--rule);
    overflow: hidden;
    margin-bottom: 8px;
  }
  .bar-identical { background: #fff; }
  .bar-changed { background: var(--accent); }
  .bar-missing { background: var(--neutral); }
  .summary-text { font-size: 14px; color: var(--text-secondary); }

  /* Toolbar */
  .toolbar { margin-bottom: 24px; }
  .toolbar-secondary {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  .toolbar label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
  }
  .toolbar select,
  .toolbar input[type="text"] {
    padding: 8px;
    border: 1px solid var(--rule);
    border-radius: 2px;
    font-size: 14px;
    color: var(--text);
    background: #fff;
  }

  /* Sections */
  .section-group { margin-bottom: 32px; }
  .section-title {
    border-top: 2px solid var(--text);
    padding: 8px 0 16px;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    cursor: pointer;
    background: none;
  }
  .section-title:hover { opacity: 0.7; }
  .section-count {
    font-size: 14px;
    font-weight: 400;
    color: var(--text-secondary);
    text-transform: none;
    letter-spacing: normal;
  }

  /* Tables */
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th, td { padding: 8px 16px; text-align: left; vertical-align: top; }
  th {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--rule);
    position: sticky;
    top: 0;
    z-index: 2;
    background: #fff;
  }
  th.survey-col { min-width: 90px; max-width: 130px; text-align: center; word-wrap: break-word; }
  .code-col { width: 180px; font-weight: 600; }
  .type-col { width: 110px; color: var(--text-secondary); }
  .text-col { min-width: 200px; }

  /* Row change indicators */
  tr.row-changed > td:first-child { box-shadow: inset 3px 0 0 var(--accent); }
  tr.row-missing > td:first-child { box-shadow: inset 3px 0 0 var(--neutral); }

  /* Status badges - text only */
  .status-badge {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .badge-identical, .badge-exact { color: var(--text); }
  .badge-text_changed, .badge-similar, .badge-different, .badge-structure_changed { color: var(--accent); }
  .badge-added, .badge-removed { color: var(--text-secondary); }

  /* Detail rows */
  .detail-row { display: none; }
  .detail-row.open { display: table-row; }
  .detail-content {
    padding: 16px 16px 16px 24px;
    border-left: 3px solid var(--rule);
  }
  .detail-content h4 {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
    margin: 24px 0 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--rule);
  }
  .detail-content h4:first-child { margin-top: 0; }
  .detail-content table { margin: 8px 0 16px; font-size: 14px; }
  .detail-content td, .detail-content th { padding: 8px; }
  .detail-content .text-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }

  .diff-added { color: var(--accent); font-weight: 600; }
  .diff-removed { text-decoration: line-through; color: var(--text-secondary); }
  .diff-changed { color: var(--accent); }

  /* Clickable cells */
  .clickable { cursor: pointer; text-align: center; }
  .clickable:hover { opacity: 0.7; }

  .lang-text { display: none; }
  .lang-text.active { display: inline; }
  .lang-status { display: none; }
</style>
</head>
<body>

<h1>Questionnaire Comparison Report</h1>
<p class="subtitle">Each survey compared against {{ short_names.get(reference_name, reference_name) }}</p>

{% set changed_count = status_counts.get('text_changed', 0) + status_counts.get('structure_changed', 0) %}
{% set missing_count = status_counts.get('added', 0) + status_counts.get('removed', 0) %}
{% set identical_pct = (status_counts.get('identical', 0) / total_questions * 100) if total_questions > 0 else 0 %}
{% set changed_pct = (changed_count / total_questions * 100) if total_questions > 0 else 0 %}
{% set missing_pct = (missing_count / total_questions * 100) if total_questions > 0 else 0 %}
<div class="summary">
  <div class="summary-bar">
    <div class="bar-identical" style="width:{{ "%.1f"|format(identical_pct) }}%"></div>
    <div class="bar-changed" style="width:{{ "%.1f"|format(changed_pct) }}%"></div>
    <div class="bar-missing" style="width:{{ "%.1f"|format(missing_pct) }}%"></div>
  </div>
  <p class="summary-text">{{ total_questions }} total &mdash; {{ status_counts.get('identical', 0) }} identical, {{ status_counts.get('text_changed', 0) }} text changed, {{ status_counts.get('structure_changed', 0) }} structure changed, {{ missing_count }} added/removed</p>
</div>

<div class="toolbar">
  <div class="toolbar-secondary">
    <label for="language-filter">Language</label>
    <select id="language-filter">
      {% for lang in languages %}
      <option value="{{ lang }}"{% if lang == default_language %} selected{% endif %}>{{ lang }}</option>
      {% endfor %}
    </select>
    <label for="status-filter">Filter</label>
    <select id="status-filter">
      <option value="all">All</option>
      <option value="identical">Identical</option>
      <option value="text_changed">Text Changed</option>
      <option value="structure_changed">Structure Changed</option>
      <option value="added">Added (not in {{ short_names.get(reference_name, reference_name) }})</option>
      <option value="removed">Removed (not in survey)</option>
      <option value="changed">Any Change</option>
    </select>
    <label for="search-box">Search</label>
    <input type="text" id="search-box" placeholder="Question code or text...">
  </div>
</div>

{% for section in sections %}
<div class="section-group" data-section="{{ section.name }}">
  <div class="section-title" onclick="toggleSection(this)">
    <span>{{ section.name }}</span>
    <span class="section-count">{{ section.codes | length }} questions</span>
  </div>
  <table>
    <thead>
      <tr>
        <th class="code-col">Code</th>
        <th class="type-col">Type</th>
        <th class="text-col">{{ short_names.get(reference_name, reference_name) }} Text</th>
        {% for survey in survey_names %}
        <th class="survey-col">{{ short_names.get(survey, survey) }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    {% for code in section.codes %}
      {% set q_sources = question_index.get(code, {}) %}
      {% set q_ref = q_sources.get(reference_name) %}
      {% set code_diffs = diff_lookup.get(code, {}) %}
      {# Determine worst status for this row #}
      {% set ns = namespace(worst='identical') %}
      {% for survey, qd in code_diffs.items() %}
        {% if qd.status == 'structure_changed' %}{% set ns.worst = 'structure_changed' %}
        {% elif qd.status in ('text_changed',) and ns.worst not in ('structure_changed',) %}{% set ns.worst = 'text_changed' %}
        {% elif qd.status in ('added', 'removed') and ns.worst == 'identical' %}{% set ns.worst = qd.status %}
        {% endif %}
      {% endfor %}
      {% set row_class = 'question-row' %}
      {% if ns.worst in ('text_changed', 'structure_changed') %}{% set row_class = 'question-row row-changed' %}
      {% elif ns.worst in ('added', 'removed') %}{% set row_class = 'question-row row-missing' %}{% endif %}
      <tr class="{{ row_class }}" data-code="{{ code }}" data-status="{{ ns.worst }}">
        <td class="code-col">{{ code }}</td>
        <td class="type-col">{{ q_ref.element_type if q_ref else '—' }}</td>
        <td class="text-col">
          {% if q_ref %}
            {% for lt in q_ref.texts %}
            <span class="lang-text" data-lang="{{ lt.language }}">{{ lt.text | truncate(120) }}</span>
            {% endfor %}
          {% else %}—{% endif %}
        </td>
        {% for survey in survey_names %}
          {% set qd = code_diffs.get(survey) %}
          {% if qd %}
          <td class="clickable" onclick="toggleDetail('{{ code }}')">
            <span class="status-badge badge-{{ qd.status }}">{{ qd.status | replace('_', ' ') }}</span>
          </td>
          {% else %}
          <td>—</td>
          {% endif %}
        {% endfor %}
      </tr>
      {# Detail / expandable row #}
      <tr class="detail-row" id="detail-{{ code }}">
        <td colspan="{{ 3 + survey_names | length }}">
          <div class="detail-content">
            {# Question Text Section #}
            <h4>Question</h4>
            <table>
              <tr>
                <th>Language</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {% for lang in languages %}
              <tr data-lang="{{ lang }}" class="lang-row">
                <td>{{ lang }}</td>
                {# Collect text diffs for this language across surveys #}
                {% set ref_ns = namespace(text='') %}
                {% if q_ref %}
                  {% for lt in q_ref.texts %}
                    {% if lt.language == lang %}{% set ref_ns.text = lt.text %}{% endif %}
                  {% endfor %}
                {% endif %}
                {# Find worst status for this language #}
                {% set lang_ns = namespace(worst_status='exact', worst_sim=1.0) %}
                {% for survey in survey_names %}
                  {% set qd = code_diffs.get(survey) %}
                  {% if qd and qd.text_diffs %}
                    {% for td in qd.text_diffs %}
                      {% if td.language == lang %}
                        {% if td.status == 'different' %}{% set lang_ns.worst_status = 'different' %}
                        {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst_status == 'exact' %}{% set lang_ns.worst_status = td.status %}{% endif %}
                        {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                <td><span class="status-badge badge-{{ lang_ns.worst_status }}">{{ lang_ns.worst_status }}</span></td>
                <td>{{ "%.0f" | format(lang_ns.worst_sim * 100) }}%</td>
                <td class="text-cell">{{ ref_ns.text | truncate(150) if ref_ns.text else '—' }}</td>
                {% for survey in survey_names %}
                  {% set qd = code_diffs.get(survey) %}
                  {% set survey_ns = namespace(text='') %}
                  {% if qd and qd.text_diffs %}
                    {% for td in qd.text_diffs %}
                      {% if td.language == lang %}{% set survey_ns.text = td.new_text %}{% endif %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">{{ survey_ns.text | truncate(150) if survey_ns.text else '—' }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>

            {# Answer Options Section #}
            {% set has_choices = false %}
            {% for survey in survey_names %}
              {% set qd = code_diffs.get(survey) %}
              {% if qd and qd.choice_diffs %}{% set has_choices = true %}{% endif %}
            {% endfor %}
            {% if has_choices or (q_ref and q_ref.choices) %}
            <h4>Answer Options</h4>
            <table>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {# Collect all choice codes #}
              {% set choice_codes = [] %}
              {% if q_ref %}
                {% for c in q_ref.choices %}
                  {% if c.code not in choice_codes %}{% set _ = choice_codes.append(c.code) %}{% endif %}
                {% endfor %}
              {% endif %}
              {% for survey in survey_names %}
                {% set qd = code_diffs.get(survey) %}
                {% if qd and qd.choice_diffs %}
                  {% for cd in qd.choice_diffs %}
                    {% if cd.code not in choice_codes %}{% set _ = choice_codes.append(cd.code) %}{% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% for choice_code in choice_codes %}
                {# Find reference choice text for each language #}
                {% set ref_choice_texts = {} %}
                {% if q_ref %}
                  {% for c in q_ref.choices %}
                    {% if c.code == choice_code %}
                      {% for lt in c.texts %}
                        {% set _ = ref_choice_texts.__setitem__(lt.language, lt.text) %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {# Find status per language (worst across surveys for each language) #}
                {% set choice_lang_status = {} %}
                {% set choice_lang_sim = {} %}
                {% for lang in languages %}
                  {% set lang_ns = namespace(worst='exact', worst_sim=1.0, has_structural=false) %}
                  {% for survey in survey_names %}
                    {% set qd = code_diffs.get(survey) %}
                    {% if qd and qd.choice_diffs %}
                      {% for cd in qd.choice_diffs %}
                        {% if cd.code == choice_code %}
                          {% if cd.status in ('added', 'removed') %}
                            {% set lang_ns.has_structural = true %}
                            {% set lang_ns.worst = cd.status %}
                          {% elif cd.text_diffs %}
                            {% for td in cd.text_diffs %}
                              {% if td.language == lang %}
                                {% if td.status == 'different' %}{% set lang_ns.worst = 'different' %}
                                {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst == 'exact' %}{% set lang_ns.worst = td.status %}{% endif %}
                                {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% set _ = choice_lang_status.__setitem__(lang, lang_ns.worst) %}
                  {% set _ = choice_lang_sim.__setitem__(lang, lang_ns.worst_sim) %}
                {% endfor %}
              <tr>
                <td>{{ choice_code }}</td>
                <td>
                  {% for lang in languages %}
                  <span class="status-badge badge-{{ choice_lang_status.get(lang, 'exact') }} lang-status" data-lang="{{ lang }}">{{ choice_lang_status.get(lang, 'exact') | replace('_', ' ') }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% for lang in languages %}
                  <span class="lang-status" data-lang="{{ lang }}">{{ "%.0f" | format(choice_lang_sim.get(lang, 1.0) * 100) }}%</span>
                  {% endfor %}
                </td>
                <td class="text-cell">
                  {% for lang in languages %}
                  <span class="lang-text" data-lang="{{ lang }}">{{ ref_choice_texts.get(lang, '') | truncate(100) if ref_choice_texts.get(lang) else '—' }}</span>
                  {% endfor %}
                </td>
                {% for survey in survey_names %}
                  {% set survey_choice_texts = {} %}
                  {% set q_survey = q_sources.get(survey) %}
                  {% if q_survey %}
                    {% for c in q_survey.choices %}
                      {% if c.code == choice_code %}
                        {% for lt in c.texts %}
                          {% set _ = survey_choice_texts.__setitem__(lt.language, lt.text) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">
                    {% for lang in languages %}
                    <span class="lang-text" data-lang="{{ lang }}">{{ survey_choice_texts.get(lang, '') | truncate(100) if survey_choice_texts.get(lang) else '—' }}</span>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}

            {# Matrix Rows Section #}
            {% set has_rows = false %}
            {% for survey in survey_names %}
              {% set qd = code_diffs.get(survey) %}
              {% if qd and qd.matrix_row_diffs %}{% set has_rows = true %}{% endif %}
            {% endfor %}
            {% if has_rows or (q_ref and q_ref.matrix_rows) %}
            <h4>Matrix Rows</h4>
            <table>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {# Collect all row codes #}
              {% set row_codes = [] %}
              {% if q_ref and q_ref.matrix_rows %}
                {% for r in q_ref.matrix_rows %}
                  {% if r.code not in row_codes %}{% set _ = row_codes.append(r.code) %}{% endif %}
                {% endfor %}
              {% endif %}
              {% for survey in survey_names %}
                {% set qd = code_diffs.get(survey) %}
                {% if qd and qd.matrix_row_diffs %}
                  {% for rd in qd.matrix_row_diffs %}
                    {% if rd.code not in row_codes %}{% set _ = row_codes.append(rd.code) %}{% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% for row_code in row_codes %}
                {# Find reference row text for each language #}
                {% set ref_row_texts = {} %}
                {% if q_ref and q_ref.matrix_rows %}
                  {% for r in q_ref.matrix_rows %}
                    {% if r.code == row_code %}
                      {% for lt in r.texts %}
                        {% set _ = ref_row_texts.__setitem__(lt.language, lt.text) %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {# Find status per language (worst across surveys for each language) #}
                {% set row_lang_status = {} %}
                {% set row_lang_sim = {} %}
                {% for lang in languages %}
                  {% set lang_ns = namespace(worst='exact', worst_sim=1.0, has_structural=false) %}
                  {% for survey in survey_names %}
                    {% set qd = code_diffs.get(survey) %}
                    {% if qd and qd.matrix_row_diffs %}
                      {% for rd in qd.matrix_row_diffs %}
                        {% if rd.code == row_code %}
                          {% if rd.status in ('added', 'removed') %}
                            {% set lang_ns.has_structural = true %}
                            {% set lang_ns.worst = rd.status %}
                          {% elif rd.text_diffs %}
                            {% for td in rd.text_diffs %}
                              {% if td.language == lang %}
                                {% if td.status == 'different' %}{% set lang_ns.worst = 'different' %}
                                {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst == 'exact' %}{% set lang_ns.worst = td.status %}{% endif %}
                                {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% set _ = row_lang_status.__setitem__(lang, lang_ns.worst) %}
                  {% set _ = row_lang_sim.__setitem__(lang, lang_ns.worst_sim) %}
                {% endfor %}
              <tr>
                <td>{{ row_code }}</td>
                <td>
                  {% for lang in languages %}
                  <span class="status-badge badge-{{ row_lang_status.get(lang, 'exact') }} lang-status" data-lang="{{ lang }}">{{ row_lang_status.get(lang, 'exact') | replace('_', ' ') }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% for lang in languages %}
                  <span class="lang-status" data-lang="{{ lang }}">{{ "%.0f" | format(row_lang_sim.get(lang, 1.0) * 100) }}%</span>
                  {% endfor %}
                </td>
                <td class="text-cell">
                  {% for lang in languages %}
                  <span class="lang-text" data-lang="{{ lang }}">{{ ref_row_texts.get(lang, '') | truncate(100) if ref_row_texts.get(lang) else '—' }}</span>
                  {% endfor %}
                </td>
                {% for survey in survey_names %}
                  {% set survey_row_texts = {} %}
                  {% set q_survey = q_sources.get(survey) %}
                  {% if q_survey and q_survey.matrix_rows %}
                    {% for r in q_survey.matrix_rows %}
                      {% if r.code == row_code %}
                        {% for lt in r.texts %}
                          {% set _ = survey_row_texts.__setitem__(lt.language, lt.text) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">
                    {% for lang in languages %}
                    <span class="lang-text" data-lang="{{ lang }}">{{ survey_row_texts.get(lang, '') | truncate(100) if survey_row_texts.get(lang) else '—' }}</span>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}

            {# Matrix Columns Section #}
            {% set has_cols = false %}
            {% for survey in survey_names %}
              {% set qd = code_diffs.get(survey) %}
              {% if qd and qd.matrix_column_diffs %}{% set has_cols = true %}{% endif %}
            {% endfor %}
            {% if has_cols or (q_ref and q_ref.matrix_column_groups) %}
            <h4>Matrix Columns</h4>
            <table>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Similarity</th>
                <th>{{ short_names.get(reference_name, reference_name) }} Text</th>
                {% for survey in survey_names %}
                <th>{{ short_names.get(survey, survey) }} Text</th>
                {% endfor %}
              </tr>
              {# Collect all column codes #}
              {% set col_codes = [] %}
              {% if q_ref and q_ref.matrix_column_groups %}
                {% for cg in q_ref.matrix_column_groups %}
                  {% for c in cg.columns %}
                    {% if c.code not in col_codes %}{% set _ = col_codes.append(c.code) %}{% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
              {% for survey in survey_names %}
                {% set qd = code_diffs.get(survey) %}
                {% if qd and qd.matrix_column_diffs %}
                  {% for cd in qd.matrix_column_diffs %}
                    {% if cd.code not in col_codes %}{% set _ = col_codes.append(cd.code) %}{% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% for col_code in col_codes %}
                {# Find reference column text for each language #}
                {% set ref_col_texts = {} %}
                {% if q_ref and q_ref.matrix_column_groups %}
                  {% for cg in q_ref.matrix_column_groups %}
                    {% for c in cg.columns %}
                      {% if c.code == col_code %}
                        {% for lt in c.texts %}
                          {% set _ = ref_col_texts.__setitem__(lt.language, lt.text) %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                {% endif %}
                {# Find status per language (worst across surveys for each language) #}
                {% set col_lang_status = {} %}
                {% set col_lang_sim = {} %}
                {% for lang in languages %}
                  {% set lang_ns = namespace(worst='exact', worst_sim=1.0, has_structural=false) %}
                  {% for survey in survey_names %}
                    {% set qd = code_diffs.get(survey) %}
                    {% if qd and qd.matrix_column_diffs %}
                      {% for cd in qd.matrix_column_diffs %}
                        {% if cd.code == col_code %}
                          {% if cd.status in ('added', 'removed') %}
                            {% set lang_ns.has_structural = true %}
                            {% set lang_ns.worst = cd.status %}
                          {% elif cd.text_diffs %}
                            {% for td in cd.text_diffs %}
                              {% if td.language == lang %}
                                {% if td.status == 'different' %}{% set lang_ns.worst = 'different' %}
                                {% elif td.status in ('similar', 'added', 'removed') and lang_ns.worst == 'exact' %}{% set lang_ns.worst = td.status %}{% endif %}
                                {% if td.similarity < lang_ns.worst_sim %}{% set lang_ns.worst_sim = td.similarity %}{% endif %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  {% set _ = col_lang_status.__setitem__(lang, lang_ns.worst) %}
                  {% set _ = col_lang_sim.__setitem__(lang, lang_ns.worst_sim) %}
                {% endfor %}
              <tr>
                <td>{{ col_code }}</td>
                <td>
                  {% for lang in languages %}
                  <span class="status-badge badge-{{ col_lang_status.get(lang, 'exact') }} lang-status" data-lang="{{ lang }}">{{ col_lang_status.get(lang, 'exact') | replace('_', ' ') }}</span>
                  {% endfor %}
                </td>
                <td>
                  {% for lang in languages %}
                  <span class="lang-status" data-lang="{{ lang }}">{{ "%.0f" | format(col_lang_sim.get(lang, 1.0) * 100) }}%</span>
                  {% endfor %}
                </td>
                <td class="text-cell">
                  {% for lang in languages %}
                  <span class="lang-text" data-lang="{{ lang }}">{{ ref_col_texts.get(lang, '') | truncate(100) if ref_col_texts.get(lang) else '—' }}</span>
                  {% endfor %}
                </td>
                {% for survey in survey_names %}
                  {% set survey_col_texts = {} %}
                  {% set q_survey = q_sources.get(survey) %}
                  {% if q_survey and q_survey.matrix_column_groups %}
                    {% for cg in q_survey.matrix_column_groups %}
                      {% for c in cg.columns %}
                        {% if c.code == col_code %}
                          {% for lt in c.texts %}
                            {% set _ = survey_col_texts.__setitem__(lt.language, lt.text) %}
                          {% endfor %}
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  {% endif %}
                  <td class="text-cell">
                    {% for lang in languages %}
                    <span class="lang-text" data-lang="{{ lang }}">{{ survey_col_texts.get(lang, '') | truncate(100) if survey_col_texts.get(lang) else '—' }}</span>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}

          </div>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endfor %}

<script>
function toggleDetail(code) {
  const row = document.getElementById('detail-' + code);
  if (row) row.classList.toggle('open');
}

function toggleSection(el) {
  const table = el.nextElementSibling;
  if (table) table.style.display = table.style.display === 'none' ? '' : 'none';
}

// Language filter - show/hide text spans and status badges based on selected language
function updateLanguageDisplay() {
  const lang = document.getElementById('language-filter').value;
  // Update main table text columns
  document.querySelectorAll('.lang-text').forEach(function(el) {
    el.classList.toggle('active', el.dataset.lang === lang);
  });
  // Update detail table rows
  document.querySelectorAll('.lang-row').forEach(function(row) {
    row.style.display = row.dataset.lang === lang ? '' : 'none';
  });
  // Update language-specific status badges and similarity values
  document.querySelectorAll('.lang-status').forEach(function(el) {
    el.style.display = el.dataset.lang === lang ? '' : 'none';
  });
}

document.getElementById('language-filter').addEventListener('change', updateLanguageDisplay);
// Initialize on load
updateLanguageDisplay();

document.getElementById('status-filter').addEventListener('change', function() {
  const val = this.value;
  document.querySelectorAll('.question-row').forEach(function(row) {
    const status = row.dataset.status;
    let show = true;
    if (val === 'changed') {
      show = status !== 'identical';
    } else if (val !== 'all') {
      show = status === val;
    }
    row.style.display = show ? '' : 'none';
    // Also hide detail row
    const detailRow = document.getElementById('detail-' + row.dataset.code);
    if (detailRow && !show) { detailRow.classList.remove('open'); detailRow.style.display = 'none'; }
    else if (detailRow && show) { detailRow.style.display = ''; }
  });
});

document.getElementById('search-box').addEventListener('input', function() {
  const term = this.value.toLowerCase();
  document.querySelectorAll('.question-row').forEach(function(row) {
    const text = row.textContent.toLowerCase();
    const match = !term || text.includes(term);
    row.style.display = match ? '' : 'none';
    const detailRow = document.getElementById('detail-' + row.dataset.code);
    if (detailRow && !match) { detailRow.classList.remove('open'); detailRow.style.display = 'none'; }
    else if (detailRow && match) { detailRow.style.display = ''; }
  });
});
</script>

</body>
</html>
